<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏™‡∏±‡πâ‡∏ô - ‡∏£‡∏û.‡∏´‡∏ô‡∏≠‡∏á‡∏™‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"/>
    
    <style>
        :root {
            --primary-pink: #FF69B4;
            --soft-pink: #FFB6C1;
            --dark-pink: #C71585;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
            --hover-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        * {
            font-family: 'Sarabun', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #ffeef8 0%, #fff5f8 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Navbar Styles */
        .navbar-custom {
            background: linear-gradient(135deg, var(--dark-pink), #8B008B);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* Header Section */
        .header-section {
            background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
            color: white;
            padding: 40px 0;
            border-radius: 0 0 50px 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 15s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .header-section h1 {
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        /* Card Styles */
        .card-custom {
            border: none;
            border-radius: 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            background: white;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .card-header-custom {
            background: linear-gradient(135deg, var(--soft-pink), var(--primary-pink));
            color: white;
            font-weight: 600;
            padding: 20px 25px;
            border: none;
            font-size: 1.1rem;
        }

        .card-header-custom i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        /* Menu Button Styles */
        .menu-card {
            border-radius: 30px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            height: 100%;
        }

        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.3));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .menu-card:hover::before {
            opacity: 1;
        }

        .menu-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .menu-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Form Styles */
        .form-label {
            font-weight: 600;
            color: var(--dark-pink);
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border-radius: 15px;
            border: 2px solid #e9ecef;
            padding: 12px 18px;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-pink);
            box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.15);
        }

        /* Button Styles */
        .btn-custom {
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            border: none;
        }

        .btn-outline-pink {
            color: var(--dark-pink);
            border: 2px solid var(--primary-pink);
            background: white;
        }

        .btn-outline-pink:hover,
        .btn-check:checked + .btn-outline-pink {
            background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.3);
        }

        /* Question Card Styles */
        .question-item {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .question-item:hover {
            border-color: var(--soft-pink);
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.1);
        }

        .question-text {
            font-weight: 600;
            color: #555;
            font-size: 1.05rem;
            margin-bottom: 15px;
        }

        /* Map Styles */
        #map {
            height: 500px;
            width: 100%;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .spinner-custom {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Chat Styles */
        .floating-chat-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--dark-pink), #8B008B);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 5px 20px rgba(199, 21, 133, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
        }

        .floating-chat-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 8px 25px rgba(199, 21, 133, 0.5);
        }

        .chat-window {
            position: fixed;
            bottom: 110px;
            right: 30px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--dark-pink), #8B008B);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .chat-body {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 20px;
            max-width: 80%;
            font-size: 0.95rem;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: linear-gradient(135deg, var(--soft-pink), var(--primary-pink));
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.ai {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 5px;
        }

        /* Dashboard Styles */
        .stat-card {
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            color: white;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .stat-card h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin: 0;
        }

        /* Table Styles */
        .table-custom {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .table-custom thead {
            background: linear-gradient(135deg, var(--soft-pink), var(--primary-pink));
            color: white;
        }

        .table-custom thead th {
            border: none;
            padding: 18px 15px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .table-custom tbody tr {
            transition: all 0.3s;
            border-bottom: 1px solid #f0f0f0;
        }

        .table-custom tbody tr:hover {
            background: linear-gradient(135deg, #fff5f8, #ffeef8);
            transform: scale(1.01);
        }

        .badge-custom {
            padding: 8px 15px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
        }

        .filter-section .form-control,
        .filter-section .form-select {
            border-radius: 10px;
        }

        /* Login Overlay */
        .login-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .login-card {
            background: white;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
            border: 3px solid var(--primary-pink);
            max-width: 400px;
            width: 100%;
        }

        .blur-content {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }

        /* History Modal */
        .history-timeline {
            position: relative;
            padding-left: 30px;
        }

        .history-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--primary-pink), var(--dark-pink));
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid var(--primary-pink);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -36px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-pink);
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--primary-pink);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-section h1 { font-size: 1.8rem; }
            .menu-icon { font-size: 2.5rem; }
            .chat-window { width: 90%; right: 5%; }
            .stat-card h1 { font-size: 2.5rem; }
        }

        /* Section Display */
        #assessmentSection, #dashboardSection { display: none; }
        #landingSection { display: block; }

        /* Smooth Animations */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-custom"></div>
        <h4 class="mt-4" style="color: var(--dark-pink);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</h4>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom sticky-top">
        <div class="container">
            <a class="navbar-brand animate__animated animate__fadeIn" href="#" onclick="showSection('landing')">
                <i class="fas fa-heartbeat me-2"></i>ADHD Screening System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('landing')">
                            <i class="fas fa-home me-1"></i>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('assessment')">
                            <i class="fas fa-clipboard-list me-1"></i>‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('dashboard')">
                            <i class="fas fa-chart-line me-1"></i>Dashboard
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="header-section text-center animate__animated animate__fadeIn">
        <div class="container">
            <h1><i class="fas fa-hospital me-3"></i>‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏´‡∏ô‡∏≠‡∏á‡∏™‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</h1>
            <p class="lead mb-0 mt-2">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏™‡∏±‡πâ‡∏ô (ADHD Screening System)</p>
            <p class="mt-2"><i class="fas fa-brain me-2"></i>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
        </div>
    </div>

    <div class="container pb-5">
        
        <!-- SECTION 1: LANDING PAGE -->
        <div id="landingSection" class="animate-fade-in">
            <div class="text-center mb-5">
                <h2 style="color: var(--dark-pink); font-weight: 700;">
                    <i class="fas fa-hand-holding-heart me-2"></i>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                </h2>
                <p class="text-muted fs-5">‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏™‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡πá‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å AI</p>
            </div>

            <div class="row g-4 justify-content-center mb-5">
                <div class="col-lg-4 col-md-6">
                    <div class="card menu-card text-white h-100 animate__animated animate__fadeInUp" 
                         style="background: linear-gradient(135deg, #FF69B4, #FF1493);" 
                         onclick="showSection('assessment')">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-clipboard-list menu-icon"></i>
                            <h3 class="fw-bold">‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô SNAP-IV</h3>
                            <p class="mb-0">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á ‡∏Ñ‡∏£‡∏π ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏™‡∏°.<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å</p>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-6">
                    <div class="card menu-card text-white h-100 animate__animated animate__fadeInUp animate__delay-1s" 
                         style="background: linear-gradient(135deg, #20B2AA, #008B8B);" 
                         onclick="showSection('dashboard')">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-chart-bar menu-icon"></i>
                            <h3 class="fw-bold">Dashboard ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•</h3>
                            <p class="mb-0">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç<br>‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-6">
                    <div class="card menu-card text-white h-100 animate__animated animate__fadeInUp animate__delay-2s" 
                         style="background: linear-gradient(135deg, #9370DB, #663399);" 
                         onclick="toggleChat()">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-robot menu-icon"></i>
                            <h3 class="fw-bold">‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢</h3>
                            <p class="mb-0">‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥<br>‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡πá‡∏Å</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card card-custom animate__animated animate__fadeInUp">
                <div class="card-body p-4">
                    <h5 style="color: var(--dark-pink);" class="mb-3">
                        <i class="fas fa-info-circle me-2"></i>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                    </h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check-circle text-success me-3 mt-1 fs-5"></i>
                                <div>
                                    <strong>‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</strong>
                                    <p class="text-muted mb-0 small">‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏ï‡∏£‡∏´‡∏•‡∏≤‡∏ô ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 5-10 ‡∏ô‡∏≤‡∏ó‡∏µ</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check-circle text-info me-3 mt-1 fs-5"></i>
                                <div>
                                    <strong>Dashboard</strong>
                                    <p class="text-muted mb-0 small">‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (‡∏ï‡πâ‡∏≠‡∏á Login)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check-circle text-warning me-3 mt-1 fs-5"></i>
                                <div>
                                    <strong>AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢</strong>
                                    <p class="text-muted mb-0 small">‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: ASSESSMENT FORM -->
        <div id="assessmentSection">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 style="color: var(--dark-pink);" class="fw-bold">
                    <i class="fas fa-clipboard-check me-2"></i>‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° SNAP-IV
                </h3>
                <button class="btn btn-outline-secondary rounded-pill" onclick="showSection('landing')">
                    <i class="fas fa-arrow-left me-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                </button>
            </div>

            <form id="assessmentForm">
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô -->
                <div class="card card-custom animate-slide-up">
                    <div class="card-header-custom">
                        <i class="fas fa-user-nurse"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô <span class="text-danger">*</span></label>
                                <select class="form-select" id="evaluatorType" required>
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô...</option>
                                    <option value="‡∏Ñ‡∏£‡∏π">‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏±‡πâ‡∏ô</option>
                                    <option value="‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á">‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</option>
                                    <option value="‡∏£‡∏û.‡∏™‡∏ï.">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡∏£‡∏û.‡∏™‡∏ï.</option>
                                    <option value="‡∏≠‡∏™‡∏°.">‡∏≠‡∏™‡∏°.</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="evaluatorName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="evaluatorPhone" placeholder="0xx-xxx-xxxx" required>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡πá‡∏Å -->
                <div class="card card-custom animate-slide-up">
                    <div class="card-header-custom">
                        <i class="fas fa-child"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡πÄ‡∏î‡πá‡∏Å <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="childName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡πá‡∏Å" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="childAge" min="3" max="18" placeholder="6" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">‡πÄ‡∏û‡∏®</label>
                                <select class="form-select" id="childGender">
                                    <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
                                    <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fab fa-line text-success me-1"></i>Line ID (‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á)
                                </label>
                                <input type="text" class="form-control" id="lineId" placeholder="@example ‡∏´‡∏£‡∏∑‡∏≠ ID Line">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-envelope text-primary me-1"></i>Email (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ú‡∏•/‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢)
                                </label>
                                <input type="email" class="form-control" id="emailContact" placeholder="example@email.com">
                            </div>
                        </div>

                        <h6 class="text-secondary border-bottom pb-2 mb-3">
                            <i class="fas fa-map-marker-alt me-2"></i>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                        </h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <label class="form-label">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="houseNo" placeholder="123" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="village" placeholder="1" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">‡∏ï‡∏≥‡∏ö‡∏• <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="subDistrict" placeholder="‡∏´‡∏ô‡∏≠‡∏á‡∏™‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
                                <input type="text" class="form-control" id="district" value="‡∏´‡∏ô‡∏≠‡∏á‡∏™‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á" readonly>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
                                <input type="text" class="form-control" id="province" value="‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô" readonly>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="button" class="btn btn-custom btn-lg" 
                                    style="background: linear-gradient(135deg, #4285F4, #1976D2); color: white;"
                                    onclick="openMapModal()">
                                <i class="fas fa-map-marked-alt me-2"></i>‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                            </button>
                            <div class="mt-3">
                                <span id="locationStatus" class="badge bg-secondary">
                                    <i class="fas fa-info-circle me-1"></i>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                                </span>
                            </div>
                        </div>
                        <input type="hidden" id="lat">
                        <input type="hidden" id="lng">
                    </div>
                </div>

                <!-- ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô -->
                <div class="alert alert-info border-0 shadow-sm animate-slide-up" style="border-radius: 20px;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle fs-3 me-3"></i>
                        <div>
                            <h6 class="mb-1 fw-bold">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h6>
                            <p class="mb-0">
                                <span class="badge bg-success me-2">0 = ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏¢</span>
                                <span class="badge bg-info me-2">1 = ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</span>
                                <span class="badge bg-warning me-2">2 = ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å</span>
                                <span class="badge bg-danger">3 = ‡∏°‡∏≤‡∏Å</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô -->
                <div class="card card-custom animate-slide-up">
                    <div class="card-header-custom">
                        <i class="fas fa-tasks"></i>‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡∏™‡∏°‡∏≤‡∏ò‡∏¥ (Inattention)
                    </div>
                    <div class="card-body p-4" id="section1-container"></div>
                </div>

                <div class="card card-custom animate-slide-up">
                    <div class="card-header-custom">
                        <i class="fas fa-running"></i>‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ã‡∏ô/‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏°‡πà‡∏ô‡∏¥‡πà‡∏á (Hyperactivity)
                    </div>
                    <div class="card-body p-4" id="section2-container"></div>
                </div>

                <div class="card card-custom animate-slide-up">
                    <div class="card-header-custom">
                        <i class="fas fa-hand-paper"></i>‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏∑‡πâ‡∏≠/‡∏ï‡πà‡∏≠‡∏ï‡πâ‡∏≤‡∏ô (Oppositional Defiant)
                    </div>
                    <div class="card-body p-4" id="section3-container"></div>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-custom btn-lg text-white" 
                            style="background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));">
                        <i class="fas fa-paper-plane me-2"></i>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </form>
        </div>

        <!-- SECTION 3: DASHBOARD -->
        <div id="dashboardSection">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 style="color: var(--dark-pink);" class="fw-bold">
                    <i class="fas fa-chart-line me-2"></i>Dashboard ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•
                </h3>
                <div>
                    <button class="btn btn-outline-secondary rounded-pill me-2" onclick="showSection('landing')">
                        <i class="fas fa-home me-1"></i>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                    </button>
                    <button id="logoutBtn" class="btn btn-danger rounded-pill" onclick="logout()" style="display:none;">
                        <i class="fas fa-sign-out-alt me-1"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>
            
            <!-- Stats Cards (Always Visible) -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <h3><i class="fas fa-users me-2"></i>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <h1 id="statTotal">0</h1>
                        <small>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <h3><i class="fas fa-exclamation-triangle me-2"></i>‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á</h3>
                        <h1 id="statRisk">0</h1>
                        <small>‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                        <h3><i class="fas fa-check-circle me-2"></i>‡∏õ‡∏Å‡∏ï‡∏¥</h3>
                        <h1 id="statNormal">0</h1>
                        <small>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                        <h3><i class="fas fa-calendar-check me-2"></i>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                        <h1 id="statToday">0</h1>
                        <small>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</small>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-header-custom">
                            <i class="fas fa-chart-line me-2"></i>‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ (0-12 ‡∏õ‡∏µ)
                        </div>
                        <div class="card-body">
                            <canvas id="ageChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-header-custom">
                            <i class="fas fa-chart-bar me-2"></i>‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏®
                        </div>
                        <div class="card-body">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Tables -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-header-custom">
                            <i class="fas fa-map-marker-alt me-2"></i>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà</th>
                                            <th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                            <th class="text-center">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th>
                                            <th class="text-center">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
                                            <th class="text-center">‡∏õ‡∏Å‡∏ï‡∏¥</th>
                                        </tr>
                                    </thead>
                                    <tbody id="villageTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-header-custom">
                            <i class="fas fa-map-marker-alt me-2"></i>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡∏ö‡∏•
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>‡∏ï‡∏≥‡∏ö‡∏•</th>
                                            <th class="text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                            <th class="text-center">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th>
                                            <th class="text-center">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
                                            <th class="text-center">‡∏õ‡∏Å‡∏ï‡∏¥</th>
                                        </tr>
                                    </thead>
                                    <tbody id="subdistrictTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Login Button (When not logged in) -->
            <div class="text-center mb-4" id="loginPrompt">
                <div class="alert alert-info d-inline-block" style="border-radius: 20px;">
                    <i class="fas fa-info-circle me-2"></i>
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    <button class="btn btn-primary ms-3 rounded-pill" onclick="showLoginModal()">
                        <i class="fas fa-sign-in-alt me-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="filter-section" id="filterSection" style="display:none;">
                <h5 class="mb-3"><i class="fas fa-filter me-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
                <div class="row g-3">
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="searchName" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡πá‡∏Å...">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterRisk">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</option>
                            <option value="‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á</option>
                            <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterEvaluator">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</option>
                            <option value="‡∏Ñ‡∏£‡∏π">‡∏Ñ‡∏£‡∏π</option>
                            <option value="‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á">‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</option>
                            <option value="‡∏£‡∏û.‡∏™‡∏ï.">‡∏£‡∏û.‡∏™‡∏ï.</option>
                            <option value="‡∏≠‡∏™‡∏°.">‡∏≠‡∏™‡∏°.</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="filterSubdistrict" placeholder="‡∏ï‡∏≥‡∏ö‡∏•...">
                    </div>
                    <div class="col-md-2">
                        <input type="date" class="form-control" id="filterDate">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="applyFilter()">
                            <i class="fas fa-search me-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div id="tableContainer" style="display:none;">
                <div class="card card-custom p-0">
                    <div class="p-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-list me-2"></i>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle table-custom mb-0">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-calendar me-1"></i>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th><i class="fas fa-user me-1"></i>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡πá‡∏Å</th>
                                        <th><i class="fas fa-user-tie me-1"></i>‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</th>
                                        <th><i class="fas fa-chart-bar me-1"></i>‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</th>
                                        <th><i class="fas fa-redo me-1"></i>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
                                        <th><i class="fas fa-calendar-alt me-1"></i>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                        <th><i class="fas fa-cog me-1"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboardTableBody">
                                    <!-- Data rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 25px;">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--dark-pink), #8B008B);">
                    <h5 class="modal-title text-white fw-bold">
                        <i class="fas fa-lock me-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center mb-4">
                        <i class="fas fa-user-shield fs-1 mb-3" style="color: var(--dark-pink);"></i>
                        <p class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                        <input type="text" id="loginUser" class="form-control" placeholder="Username">
                    </div>
                    <div class="mb-4">
                        <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input type="password" id="loginPass" class="form-control" placeholder="Password">
                    </div>
                    <button class="btn btn-custom w-100 text-white" 
                            style="background: linear-gradient(135deg, var(--dark-pink), #8B008B);" 
                            onclick="doLogin()">
                        <i class="fas fa-sign-in-alt me-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div class="modal fade" id="mapModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="border-radius: 25px; overflow: hidden;">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #4285F4, #1976D2);">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-map-marked-alt me-2"></i>‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="p-3 bg-light">
                        <input type="text" id="mapSearchInput" class="form-control" 
                               placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô ‡∏ï‡∏≥‡∏ö‡∏• ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠..." 
                               style="border-radius: 20px;">
                    </div>
                    <div id="map"></div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            ‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                        </small>
                    </div>
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="button" class="btn btn-primary rounded-pill" onclick="confirmLocation()">
                        <i class="fas fa-check me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content" style="border-radius: 25px;">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--soft-pink), var(--primary-pink));">
                    <h5 class="modal-title text-white fw-bold">
                        <i class="fas fa-history me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6 id="historyChildName" class="fw-bold"></h6>
                        <small class="text-muted" id="historyChildInfo"></small>
                    </div>
                    <div class="history-timeline" id="historyTimeline">
                        <!-- Timeline items will be inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div class="modal fade" id="appointmentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 25px;">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));">
                    <h5 class="modal-title text-white fw-bold">
                        <i class="fas fa-calendar-plus me-2"></i>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="appCaseId">
                    <div class="mb-3">
                        <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡πá‡∏Å</label>
                        <input type="text" id="appName" class="form-control" readonly style="background-color: #f8f9fa;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</label>
                        <input type="date" id="appDate" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</label>
                        <textarea id="appNote" class="form-control" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢..."></textarea>
                    </div>
                    <div class="alert alert-warning border-0" style="border-radius: 15px;">
                        <i class="fas fa-envelope me-2"></i>
                        <small>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á Email ‡∏´‡∏£‡∏∑‡∏≠ Line ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary rounded-pill" onclick="saveAppointment()">
                        <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content" style="border-radius: 25px;">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-clipboard-check me-2"></i>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI
                    </h5>
                </div>
                <div class="modal-body p-4">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm" style="border-radius: 20px;">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3" style="color: var(--dark-pink);">
                                        <i class="fas fa-chart-bar me-2"></i>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏î‡πâ‡∏≤‡∏ô
                                    </h6>
                                    <div class="mb-2 d-flex justify-content-between align-items-center">
                                        <span>‡∏Ç‡∏≤‡∏î‡∏™‡∏°‡∏≤‡∏ò‡∏¥:</span>
                                        <span class="badge bg-primary fs-6 px-3 py-2" id="res-score1">0</span>
                                    </div>
                                    <div class="mb-2 d-flex justify-content-between align-items-center">
                                        <span>‡∏ã‡∏ô/‡∏´‡∏∏‡∏ô‡∏´‡∏±‡∏ô:</span>
                                        <span class="badge bg-info fs-6 px-3 py-2" id="res-score2">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>‡∏î‡∏∑‡πâ‡∏≠/‡∏ï‡πà‡∏≠‡∏ï‡πâ‡∏≤‡∏ô:</span>
                                        <span class="badge bg-warning fs-6 px-3 py-2" id="res-score3">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm" style="border-radius: 20px; background: linear-gradient(135deg, #ffeef8, #fff5f8);">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3" style="color: var(--dark-pink);">
                                        <i class="fas fa-stethoscope me-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                                    </h6>
                                    <p id="res-basic-summary" class="fw-bold fs-5 mb-0">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h5 style="color: var(--dark-pink);" class="fw-bold mb-3">
                        <i class="fas fa-robot me-2"></i>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI
                    </h5>
                    <div id="ai-analysis-content" class="p-4 rounded" style="background-color: #f8f9fa; border-left: 4px solid var(--primary-pink);">
                        <!-- AI content will be inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" onclick="window.location.reload()">
                        <i class="fas fa-times me-1"></i>‡∏õ‡∏¥‡∏î
                    </button>
                    <button type="button" class="btn btn-primary rounded-pill" 
                            style="background: linear-gradient(135deg, var(--dark-pink), #8B008B); border: none;" 
                            onclick="confirmSaveToSheet()">
                        <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Chat -->
    <div class="floating-chat-btn" onclick="toggleChat()">
        <i class="fas fa-robot"></i>
    </div>
    
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <span><i class="fas fa-robot me-2"></i>AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢</span>
            <button class="btn btn-sm text-white" onclick="toggleChat()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="message ai">
                <strong>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ üëã</strong><br>
                ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡πá‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏™‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏∞
            </div>
        </div>
        <div class="input-group p-3" style="background: #f8f9fa;">
            <input type="text" class="form-control" id="chatMsg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." 
                   style="border-radius: 20px 0 0 20px;">
            <button class="btn btn-primary" onclick="sendChat()" style="border-radius: 0 20px 20px 0;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA1xmTQ_hd4n-FPyqIiUqPhAElgMRdYfUo&libraries=places&callback=initMap"></script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Configuration
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxn5cPOIXfkd9YiQJBuxFs8XVxKnn_aioeTytsrWVZk0oZSwYC8ogWpP5Z-uTckpS7x/exec";
        const AI_KEYS = [
            "AIzaSyDiqXPAnfMICeehtGSC6VwDJaH9HqTIa-E",
            "AIzaSyAuGmhGGfVIgdcBS-bDPu06I_fQpIy2Sng",
            "AIzaSyAXn2RnKle5RdJsD74PHVQbQAcOkPffkb4"
        ];
        
        let currentKeyIndex = 0;
        function getGenAI() {
            const key = AI_KEYS[currentKeyIndex];
            currentKeyIndex = (currentKeyIndex + 1) % AI_KEYS.length;
            return new GoogleGenerativeAI(key);
        }

        // Global Variables
        let map, marker, finalData = {};
        let allCases = [];
        let filteredCases = [];
        let isLoggedIn = false;
        let ageChart = null;
        let genderChart = null;
        let mapInitialized = false;

        // Map Initialization
        window.initMap = function() {
            // Don't initialize until called
            console.log('Google Maps API loaded');
        }

        function actuallyInitMap() {
            if(mapInitialized) return;
            
            const hospitalPos = { lat: 15.73315086491515, lng: 102.79444248459548 };
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 18,
                center: hospitalPos,
                mapTypeId: 'satellite',
                streetViewControl: false,
                fullscreenControl: true
            });

            marker = new google.maps.Marker({
                position: hospitalPos,
                map: map,
                draggable: true,
                title: "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡πâ‡∏≤‡∏ô (‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)",
                animation: google.maps.Animation.DROP
            });

            // Add Search Box
            const input = document.getElementById('mapSearchInput');
            const searchBox = new google.maps.places.SearchBox(input);
            
            // Bias search to map viewport
            map.addListener('bounds_changed', function() {
                searchBox.setBounds(map.getBounds());
            });

            // Listen for search box places changed
            searchBox.addListener('places_changed', function() {
                const places = searchBox.getPlaces();
                if (places.length == 0) return;
                
                const place = places[0];
                if (!place.geometry || !place.geometry.location) return;
                
                // Move marker to searched location
                marker.setPosition(place.geometry.location);
                map.setCenter(place.geometry.location);
                map.setZoom(18);
            });

            // Click to move marker
            map.addListener('click', function(e) {
                marker.setPosition(e.latLng);
            });

            document.getElementById("lat").value = hospitalPos.lat;
            document.getElementById("lng").value = hospitalPos.lng;
            
            mapInitialized = true;
        }

        window.openMapModal = function() {
            const modal = new bootstrap.Modal(document.getElementById('mapModal'));
            modal.show();
            
            // Initialize map when modal opens
            setTimeout(function() {
                if(!mapInitialized) {
                    actuallyInitMap();
                }
                // Trigger resize to fix display issues
                if(map) {
                    google.maps.event.trigger(map, 'resize');
                    map.setCenter(marker.getPosition());
                }
            }, 500);
        }

        window.confirmLocation = function() {
            const pos = marker.getPosition();
            document.getElementById("lat").value = pos.lat();
            document.getElementById("lng").value = pos.lng();
            
            document.getElementById("locationStatus").innerHTML = 
                `<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß: ${pos.lat().toFixed(5)}, ${pos.lng().toFixed(5)}</span>`;
            
            bootstrap.Modal.getInstance(document.getElementById('mapModal')).hide();
        }

        // Questions Rendering
        const questions = [
            {id: 1, text: "‡∏°‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏ö ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡πà‡∏≠‡∏¢", section: 1},
            {id: 2, text: "‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏≤‡∏ô‡πÜ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏™‡∏±‡πâ‡∏ô", section: 1},
            {id: 3, text: "‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏ü‡∏±‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏π‡∏î‡∏î‡πâ‡∏ß‡∏¢ ‡πÉ‡∏à‡∏•‡∏≠‡∏¢", section: 1},
            {id: 4, text: "‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢", section: 1},
            {id: 5, text: "‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢", section: 1},
            {id: 6, text: "‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏î‡∏ó‡∏ô", section: 1},
            {id: 7, text: "‡∏ó‡∏≥‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡∏ö‡πà‡∏≠‡∏¢ ‡∏•‡∏∑‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏•‡∏≠‡∏î", section: 1},
            {id: 8, text: "‡∏ß‡∏≠‡∏Å‡πÅ‡∏ß‡∏Å‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏á‡πà‡∏≤‡∏¢", section: 1},
            {id: 9, text: "‡∏Ç‡∏µ‡πâ‡∏•‡∏∑‡∏° ‡∏´‡∏•‡∏á‡∏•‡∏∑‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô", section: 1},
            {id: 10, text: "‡∏°‡∏∑‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏¢‡∏∏‡∏Å‡∏¢‡∏¥‡∏Å ‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏¥‡πà‡∏á", section: 2},
            {id: 11, text: "‡∏ô‡∏±‡πà‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ó‡∏µ‡πà ‡∏•‡∏∏‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏¢‡∏∑‡∏ô‡∏ö‡πà‡∏≠‡∏¢", section: 2},
            {id: 12, text: "‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏õ‡∏ß‡∏¥‡πà‡∏á‡∏°‡∏≤ ‡∏õ‡∏µ‡∏ô‡∏õ‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏•‡πÄ‡∏ó‡∏®‡∏∞", section: 2},
            {id: 13, text: "‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡πÄ‡∏™‡∏°‡∏≠", section: 2},
            {id: 14, text: "‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤", section: 2},
            {id: 15, text: "‡∏û‡∏π‡∏î‡∏°‡∏≤‡∏Å ‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î", section: 2},
            {id: 16, text: "‡∏û‡∏π‡∏î‡πÇ‡∏û‡∏•‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏ö", section: 2},
            {id: 17, text: "‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß ‡πÅ‡∏¢‡πà‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô", section: 2},
            {id: 18, text: "‡∏ä‡∏≠‡∏ö‡∏™‡∏≠‡∏î‡πÅ‡∏ó‡∏£‡∏Å ‡∏Ç‡∏±‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô", section: 2},
            {id: 19, text: "‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡πÇ‡∏°‡πÇ‡∏´‡∏á‡πà‡∏≤‡∏¢", section: 3},
            {id: 20, text: "‡πÄ‡∏ñ‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û", section: 3},
            {id: 21, text: "‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Å‡∏é ‡∏ù‡πà‡∏≤‡∏ù‡∏∑‡∏ô‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö", section: 3},
            {id: 22, text: "‡∏à‡∏á‡πÉ‡∏à‡∏Å‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô", section: 3},
            {id: 23, text: "‡πÇ‡∏ó‡∏©‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏ú‡∏¥‡∏î", section: 3},
            {id: 24, text: "‡∏Ç‡∏µ‡πâ‡∏£‡∏≥‡∏Ñ‡∏≤‡∏ç ‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î‡∏á‡πà‡∏≤‡∏¢", section: 3},
            {id: 25, text: "‡πÇ‡∏Å‡∏£‡∏ò‡∏õ‡∏∂‡∏á‡∏õ‡∏±‡∏á ‡∏Ç‡∏µ‡πâ‡πÇ‡∏°‡πÇ‡∏´", section: 3},
            {id: 26, text: "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏¥‡∏î‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏Ñ‡πâ‡∏ô ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏ó", section: 3}
        ];

        questions.forEach(q => {
            const container = document.getElementById(`section${q.section}-container`);
            const div = document.createElement("div");
            div.className = "question-item";
            div.innerHTML = `
                <p class="question-text">
                    <span class="badge bg-secondary me-2">${q.id}</span>
                    ${q.text}
                </p>
                <div class="d-flex gap-2 flex-wrap">
                    ${[0,1,2,3].map(v => `
                        <input type="radio" class="btn-check" name="q${q.id}" id="q${q.id}_${v}" value="${v}" required>
                        <label class="btn btn-outline-pink flex-fill" for="q${q.id}_${v}">
                            ${['‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏¢ (0)','‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (1)','‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å (2)','‡∏°‡∏≤‡∏Å (3)'][v]}
                        </label>
                    `).join('')}
                </div>
            `;
            container.appendChild(div);
        });

        // Form Submit
        document.getElementById('assessmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            let s1 = 0, s2 = 0, s3 = 0, answers = {}, highRisk = [];
            
            questions.forEach(q => {
                const val = parseInt(formData.get(`q${q.id}`));
                answers[`q${q.id}`] = val;
                if(q.section === 1) s1 += val;
                if(q.section === 2) s2 += val;
                if(q.section === 3) s3 += val;
                if(val >= 2) highRisk.push(`${q.text} (${val === 2 ? '‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å' : '‡∏°‡∏≤‡∏Å'})`);
            });

            let resultBasic = (s1 > 16 || s2 > 16 || s3 > 14) ? "‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå" : "‡∏õ‡∏Å‡∏ï‡∏¥";
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                const genAI = getGenAI();
                const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });
                
                const prompt = `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô SNAP-IV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ${document.getElementById('childName').value} ‡∏≠‡∏≤‡∏¢‡∏∏ ${document.getElementById('childAge').value} ‡∏õ‡∏µ
                
‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ:
- ‡∏Ç‡∏≤‡∏î‡∏™‡∏°‡∏≤‡∏ò‡∏¥: ${s1}/27 (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á > 16)
- ‡∏ã‡∏ô/‡∏´‡∏∏‡∏ô‡∏´‡∏±‡∏ô: ${s2}/27 (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á > 16)
- ‡∏î‡∏∑‡πâ‡∏≠/‡∏ï‡πà‡∏≠‡∏ï‡πâ‡∏≤‡∏ô: ${s3}/24 (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á > 14)

‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î:
${highRisk.join('\n')}

‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ:
1. ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
2. ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
3. ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
4. ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á/‡∏Ñ‡∏£‡∏π

‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô HTML ‡∏î‡πâ‡∏ß‡∏¢ <ul> <li> ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ markdown`;

                const result = await model.generateContent(prompt);
                const aiRes = result.response.text().replace(/```html/g, '').replace(/```/g, '').trim();

                document.getElementById('res-score1').innerText = s1;
                document.getElementById('res-score2').innerText = s2;
                document.getElementById('res-score3').innerText = s3;
                document.getElementById('res-basic-summary').innerText = resultBasic;
                document.getElementById('ai-analysis-content').innerHTML = aiRes;

                finalData = {
                    action: 'submit_assessment',
                    evaluatorType: document.getElementById('evaluatorType').value,
                    evaluatorName: document.getElementById('evaluatorName').value,
                    evaluatorPhone: document.getElementById('evaluatorPhone').value,
                    childName: document.getElementById('childName').value,
                    childAge: document.getElementById('childAge').value,
                    lineId: document.getElementById('lineId').value,
                    email: document.getElementById('emailContact').value,
                    houseNo: document.getElementById('houseNo').value,
                    village: document.getElementById('village').value,
                    subDistrict: document.getElementById('subDistrict').value,
                    district: document.getElementById('district').value,
                    province: document.getElementById('province').value,
                    lat: document.getElementById('lat').value,
                    lng: document.getElementById('lng').value,
                    ...answers,
                    scoreInattention: s1,
                    scoreHyperactivity: s2,
                    scoreOppositional: s3,
                    totalScore: s1 + s2 + s3,
                    resultText: resultBasic,
                    aiSummary: "Processed",
                    aiAdvice: aiRes
                };

                new bootstrap.Modal(document.getElementById('resultModal')).show();
                
            } catch(err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å AI: " + err);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });

        // Save to Sheet
        window.confirmSaveToSheet = function() {
            if(SCRIPT_URL.includes("YOUR_WEB")) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Web App URL");
                return;
            }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(finalData)
            })
            .then(() => {
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                window.location.reload();
            })
            .catch(e => {
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e);
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }

        // Section Navigation
        window.showSection = function(sec) {
            ['landingSection', 'assessmentSection', 'dashboardSection'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            if(sec === 'landing') {
                document.getElementById('landingSection').style.display = 'block';
            }
            if(sec === 'assessment') {
                document.getElementById('assessmentSection').style.display = 'block';
                window.scrollTo(0, 0);
            }
            if(sec === 'dashboard') {
                document.getElementById('dashboardSection').style.display = 'block';
                loadDashboardData();
            }
        }

        // Login
        window.showLoginModal = function() {
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        }

        window.doLogin = function() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            
            if(!u || !p) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô");
                return;
            }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({action: 'login', username: u, password: p})
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('loadingOverlay').style.display = 'none';
                if(data.status === 'success') {
                    isLoggedIn = true;
                    
                    // Close login modal
                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    if(loginModal) {
                        loginModal.hide();
                    }
                    
                    // Update view and load data if needed
                    updateDashboardView();
                    
                    // Reload data to ensure table shows
                    if(allCases.length === 0) {
                        loadDashboardData();
                    } else {
                        renderTable(filteredCases);
                    }
                } else {
                    alert("‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            })
            .catch(e => {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + e);
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }

        window.logout = function() {
            isLoggedIn = false;
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
            updateDashboardView();
        }

        // Dashboard
        function loadDashboardData() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({action: 'get_dashboard_data'})
            })
            .then(r => r.json())
            .then(res => {
                document.getElementById('loadingOverlay').style.display = 'none';
                if(res.status === 'success') {
                    allCases = res.data;
                    filteredCases = allCases;
                    updateStats(allCases);
                    
                    // Update view after loading data
                    updateDashboardView();
                } else {
                    console.error('Error loading data:', res);
                }
            })
            .catch(e => {
                console.error('Fetch error:', e);
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }

        function updateDashboardView() {
            const tableContainer = document.getElementById('tableContainer');
            const loginPrompt = document.getElementById('loginPrompt');
            const logoutBtn = document.getElementById('logoutBtn');
            const filterSection = document.getElementById('filterSection');

            if(isLoggedIn) {
                // User is logged in: Show table, Hide login prompt, Show logout
                tableContainer.style.display = 'block';
                loginPrompt.style.display = 'none';
                logoutBtn.style.display = 'block';
                filterSection.style.display = 'block';
                
                // Render table with current data
                if(allCases.length > 0) {
                    renderTable(filteredCases);
                }
            } else {
                // User is NOT logged in: Hide table, Show login prompt, Hide logout
                tableContainer.style.display = 'none';
                loginPrompt.style.display = 'block';
                logoutBtn.style.display = 'none';
                filterSection.style.display = 'none';
            }
        }

        function updateStats(data) {
            document.getElementById('statTotal').innerText = data.length;
            
            const riskCases = data.filter(d => d.AssessmentResult && d.AssessmentResult.includes('‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á'));
            document.getElementById('statRisk').innerText = riskCases.length;
            
            const normalCases = data.filter(d => d.AssessmentResult && d.AssessmentResult.includes('‡∏õ‡∏Å‡∏ï‡∏¥'));
            document.getElementById('statNormal').innerText = normalCases.length;
            
            const today = new Date().toLocaleDateString('th-TH');
            const todayAppts = data.filter(d => {
                if(!d.AppointmentDate) return false;
                const apptDate = new Date(d.AppointmentDate).toLocaleDateString('th-TH');
                return apptDate === today;
            });
            document.getElementById('statToday').innerText = todayAppts.length;
            
            // Update Charts
            updateAgeChart(data);
            updateGenderChart(data);
            updateLocationTables(data);
        }

        function updateAgeChart(data) {
            // Count by age (0-12)
            const ageCounts = {};
            const ageRisk = {};
            const ageNormal = {};
            
            for(let i = 0; i <= 12; i++) {
                ageCounts[i] = 0;
                ageRisk[i] = 0;
                ageNormal[i] = 0;
            }
            
            data.forEach(item => {
                const age = parseInt(item.ChildAge);
                if(age >= 0 && age <= 12) {
                    ageCounts[age]++;
                    if(item.AssessmentResult && item.AssessmentResult.includes('‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á')) {
                        ageRisk[age]++;
                    } else {
                        ageNormal[age]++;
                    }
                }
            });
            
            const labels = [];
            const riskData = [];
            const normalData = [];
            
            for(let i = 0; i <= 12; i++) {
                labels.push(i + ' ‡∏õ‡∏µ');
                riskData.push(ageRisk[i]);
                normalData.push(ageNormal[i]);
            }
            
            const ctx = document.getElementById('ageChart');
            
            if(ageChart) {
                ageChart.destroy();
            }
            
            ageChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á',
                        data: riskData,
                        borderColor: '#f5576c',
                        backgroundColor: 'rgba(245, 87, 108, 0.2)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: '‡∏õ‡∏Å‡∏ï‡∏¥',
                        data: normalData,
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateGenderChart(data) {
            const genderCounts = { '‡∏ä‡∏≤‡∏¢': 0, '‡∏´‡∏ç‡∏¥‡∏á': 0 };
            const genderRisk = { '‡∏ä‡∏≤‡∏¢': 0, '‡∏´‡∏ç‡∏¥‡∏á': 0 };
            const genderNormal = { '‡∏ä‡∏≤‡∏¢': 0, '‡∏´‡∏ç‡∏¥‡∏á': 0 };
            
            data.forEach(item => {
                const gender = (item.ChildGender && String(item.ChildGender).trim()) || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if(gender === '‡∏ä‡∏≤‡∏¢' || gender === '‡∏´‡∏ç‡∏¥‡∏á') {
                    genderCounts[gender]++;
                    if(item.AssessmentResult && String(item.AssessmentResult).includes('‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á')) {
                        genderRisk[gender]++;
                    } else {
                        genderNormal[gender]++;
                    }
                }
            });
            
            const ctx = document.getElementById('genderChart');
            
            if(genderChart) {
                genderChart.destroy();
            }
            
            genderChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['‡∏ä‡∏≤‡∏¢', '‡∏´‡∏ç‡∏¥‡∏á'],
                    datasets: [{
                        label: '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á',
                        data: [genderRisk['‡∏ä‡∏≤‡∏¢'], genderRisk['‡∏´‡∏ç‡∏¥‡∏á']],
                        backgroundColor: '#f5576c'
                    }, {
                        label: '‡∏õ‡∏Å‡∏ï‡∏¥',
                        data: [genderNormal['‡∏ä‡∏≤‡∏¢'], genderNormal['‡∏´‡∏ç‡∏¥‡∏á']],
                        backgroundColor: '#4facfe'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            stacked: false
                        }
                    }
                }
            });
        }

        function updateLocationTables(data) {
            // Village Table
            const villageStats = {};
            data.forEach(item => {
                const village = (item.Village && String(item.Village).trim()) || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if(!villageStats[village]) {
                    villageStats[village] = { total: 0, risk: 0, normal: 0 };
                }
                villageStats[village].total++;
                if(item.AssessmentResult && String(item.AssessmentResult).includes('‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á')) {
                    villageStats[village].risk++;
                } else {
                    villageStats[village].normal++;
                }
            });
            
            const villageTable = document.getElementById('villageTable');
            villageTable.innerHTML = '';
            
            Object.keys(villageStats).sort((a, b) => {
                const numA = parseInt(a.replace(/[^0-9]/g, '')) || 0;
                const numB = parseInt(b.replace(/[^0-9]/g, '')) || 0;
                return numA - numB;
            }).forEach(village => {
                const stat = villageStats[village];
                const percent = ((stat.total / data.length) * 100).toFixed(1);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${village}</td>
                    <td class="text-center"><strong>${stat.total}</strong></td>
                    <td class="text-center">${percent}%</td>
                    <td class="text-center"><span class="badge bg-danger">${stat.risk}</span></td>
                    <td class="text-center"><span class="badge bg-success">${stat.normal}</span></td>
                `;
                villageTable.appendChild(tr);
            });
            
            // Subdistrict Table
            const subdistrictStats = {};
            data.forEach(item => {
                const subdistrict = (item.SubDistrict && String(item.SubDistrict).trim()) || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if(!subdistrictStats[subdistrict]) {
                    subdistrictStats[subdistrict] = { total: 0, risk: 0, normal: 0 };
                }
                subdistrictStats[subdistrict].total++;
                if(item.AssessmentResult && String(item.AssessmentResult).includes('‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á')) {
                    subdistrictStats[subdistrict].risk++;
                } else {
                    subdistrictStats[subdistrict].normal++;
                }
            });
            
            const subdistrictTable = document.getElementById('subdistrictTable');
            subdistrictTable.innerHTML = '';
            
            Object.keys(subdistrictStats).sort().forEach(subdistrict => {
                const stat = subdistrictStats[subdistrict];
                const percent = ((stat.total / data.length) * 100).toFixed(1);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${subdistrict}</td>
                    <td class="text-center"><strong>${stat.total}</strong></td>
                    <td class="text-center">${percent}%</td>
                    <td class="text-center"><span class="badge bg-danger">${stat.risk}</span></td>
                    <td class="text-center"><span class="badge bg-success">${stat.normal}</span></td>
                `;
                subdistrictTable.appendChild(tr);
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('dashboardTableBody');
            if(!tbody) {
                console.error('Table body element not found!');
                return;
            }
            
            tbody.innerHTML = '';
            
            console.log('Rendering table with data:', data.length, 'items');
            
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                return;
            }
            
            // Group by child name to count assessments
            const childGroups = {};
            data.forEach(item => {
                const name = item.ChildName;
                if(!childGroups[name]) {
                    childGroups[name] = [];
                }
                childGroups[name].push(item);
            });
            
            console.log('Grouped into', Object.keys(childGroups).length, 'unique children');
            
            // Render unique children with their latest assessment
            Object.keys(childGroups).forEach(childName => {
                const assessments = childGroups[childName];
                const latest = assessments[assessments.length - 1]; // Latest assessment
                const count = assessments.length;
                
                const date = new Date(latest.Timestamp).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Check contact info - handle null/undefined safely
                const hasLine = latest.LineID && String(latest.LineID).trim() !== '';
                const hasEmail = latest.Email && String(latest.Email).trim() !== '';
                const hasPhone = latest.EvaluatorPhone && String(latest.EvaluatorPhone).trim() !== '';
                
                const contactBadges = [];
                if(hasPhone) contactBadges.push('<i class="fas fa-phone text-success" title="‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£"></i>');
                if(hasLine) contactBadges.push('<i class="fab fa-line text-success" title="‡∏°‡∏µ Line"></i>');
                if(hasEmail) contactBadges.push('<i class="fas fa-envelope text-success" title="‡∏°‡∏µ Email"></i>');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${date}</td>
                    <td>
                        <strong>${latest.ChildName}</strong><br>
                        <small class="text-muted">‡∏≠‡∏≤‡∏¢‡∏∏ ${latest.ChildAge} ‡∏õ‡∏µ</small><br>
                        ${contactBadges.length > 0 ? `<small>${contactBadges.join(' ')}</small>` : '<small class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</small>'}
                    </td>
                    <td>
                        ${latest.EvaluatorName}<br>
                        <span class="badge bg-secondary">${latest.EvaluatorType}</span>
                    </td>
                    <td>
                        <span class="badge badge-custom ${latest.AssessmentResult.includes('‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á') ? 'bg-danger' : 'bg-success'}">
                            ${latest.AssessmentResult}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary rounded-pill" onclick='showHistory(${JSON.stringify(childName)})'>
                            <i class="fas fa-history me-1"></i>${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                        </button>
                    </td>
                    <td>
                        ${latest.AppointmentDate ? new Date(latest.AppointmentDate).toLocaleDateString('th-TH') : 
                          '<span class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ</span>'}
                    </td>
                    <td>
                        <div class="d-flex flex-column gap-1" style="font-size: 0.85rem;">
                            ${hasEmail ? `
                                <div>
                                    <i class="fas fa-envelope text-primary me-1"></i>
                                    <a href="mailto:${latest.Email}" class="text-decoration-none">
                                        ${latest.Email}
                                    </a>
                                </div>
                            ` : '<small class="text-muted"><i class="fas fa-envelope me-1"></i>‡πÑ‡∏°‡πà‡∏°‡∏µ Email</small>'}
                            
                            ${hasPhone ? `
                                <div>
                                    <i class="fas fa-phone text-success me-1"></i>
                                    <a href="tel:${latest.EvaluatorPhone}" class="text-decoration-none">
                                        ${latest.EvaluatorPhone}
                                    </a>
                                </div>
                            ` : '<small class="text-muted"><i class="fas fa-phone me-1"></i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</small>'}
                            
                            ${hasLine ? `
                                <div>
                                    <i class="fab fa-line text-success me-1"></i>
                                    <span class="text-dark">${latest.LineID}</span>
                                </div>
                            ` : '<small class="text-muted"><i class="fab fa-line me-1"></i>‡πÑ‡∏°‡πà‡∏°‡∏µ Line ID</small>'}
                            
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick='openAppoint("${latest.ID}", "${latest.ChildName}", "${latest.Email || ''}", "${latest.LineID || ''}")' 
                                        title="‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢">
                                    <i class="fas fa-calendar-plus me-1"></i>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢
                                </button>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            console.log('Table rendered successfully');
        }

        // Filter Function
        window.applyFilter = function() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const filterRisk = document.getElementById('filterRisk').value;
            const filterEvaluator = document.getElementById('filterEvaluator').value;
            const filterSubdistrict = document.getElementById('filterSubdistrict').value.toLowerCase();
            const filterDate = document.getElementById('filterDate').value;
            
            filteredCases = allCases.filter(item => {
                let match = true;
                
                if(searchName && (!item.ChildName || !String(item.ChildName).toLowerCase().includes(searchName))) {
                    match = false;
                }
                
                if(filterRisk && (!item.AssessmentResult || !String(item.AssessmentResult).includes(filterRisk))) {
                    match = false;
                }
                
                if(filterEvaluator && String(item.EvaluatorType) !== filterEvaluator) {
                    match = false;
                }
                
                if(filterSubdistrict && (!item.SubDistrict || !String(item.SubDistrict).toLowerCase().includes(filterSubdistrict))) {
                    match = false;
                }
                
                if(filterDate) {
                    const itemDate = new Date(item.Timestamp).toISOString().split('T')[0];
                    if(itemDate !== filterDate) {
                        match = false;
                    }
                }
                
                return match;
            });
            
            updateStats(filteredCases);
            renderTable(filteredCases);
        }

        // Show History
        window.showHistory = function(childName) {
            const childCases = allCases.filter(c => c.ChildName === childName);
            
            if(childCases.length === 0) return;
            
            const latestCase = childCases[childCases.length - 1];
            
            document.getElementById('historyChildName').innerText = childName;
            
            // Contact info - handle null/undefined safely
            const contactInfo = [];
            if(latestCase.EvaluatorPhone && String(latestCase.EvaluatorPhone).trim()) {
                contactInfo.push(`üìû ${latestCase.EvaluatorPhone}`);
            }
            if(latestCase.LineID && String(latestCase.LineID).trim()) {
                contactInfo.push(`üí¨ Line: ${latestCase.LineID}`);
            }
            if(latestCase.Email && String(latestCase.Email).trim()) {
                contactInfo.push(`üìß ${latestCase.Email}`);
            }
            
            document.getElementById('historyChildInfo').innerHTML = 
                `‡∏≠‡∏≤‡∏¢‡∏∏ ${latestCase.ChildAge} ‡∏õ‡∏µ | ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${childCases.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á<br>` +
                (contactInfo.length > 0 ? `<small class="text-muted">${contactInfo.join(' | ')}</small>` : '<small class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</small>');
            
            const timeline = document.getElementById('historyTimeline');
            timeline.innerHTML = '';
            
            childCases.reverse().forEach((item, idx) => {
                const date = new Date(item.Timestamp).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const div = document.createElement('div');
                div.className = 'timeline-item';
                
                // Clean AI advice - remove markdown code blocks
                let aiAdvice = item.AIAdvice || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                aiAdvice = aiAdvice.replace(/```html/g, '').replace(/```/g, '').trim();
                
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0 fw-bold">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${childCases.length - idx}</h6>
                        <small class="text-muted">${date}</small>
                    </div>
                    <p class="mb-2">
                        <strong>‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</strong> ${item.EvaluatorName} (${item.EvaluatorType})
                    </p>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <small class="text-muted">‡∏Ç‡∏≤‡∏î‡∏™‡∏°‡∏≤‡∏ò‡∏¥:</small><br>
                            <span class="badge bg-primary">${item.Score_Inattention || 0}/27</span>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">‡∏ã‡∏ô/‡∏´‡∏∏‡∏ô‡∏´‡∏±‡∏ô:</small><br>
                            <span class="badge bg-info">${item.Score_Hyperactivity || 0}/27</span>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">‡∏î‡∏∑‡πâ‡∏≠/‡∏ï‡πà‡∏≠‡∏ï‡πâ‡∏≤‡∏ô:</small><br>
                            <span class="badge bg-warning">${item.Score_Oppositional || 0}/24</span>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <span class="badge ${item.AssessmentResult.includes('‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á') ? 'bg-danger' : 'bg-success'}">
                            ${item.AssessmentResult}
                        </span>
                    </div>
                    
                    ${aiAdvice !== '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' ? `
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-secondary w-100" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#aiDetail${idx}">
                                <i class="fas fa-robot me-1"></i>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI
                            </button>
                            <div class="collapse mt-2" id="aiDetail${idx}">
                                <div class="card card-body bg-light" style="font-size: 0.85rem;">
                                    ${aiAdvice}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${item.AppointmentDate ? `
                        <div class="mt-2">
                            <small class="text-primary">
                                <i class="fas fa-calendar-check me-1"></i>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢: ${new Date(item.AppointmentDate).toLocaleDateString('th-TH')}
                            </small>
                        </div>
                    ` : ''}
                `;
                timeline.appendChild(div);
            });
            
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        }

        // Appointment
        window.openAppoint = function(id, name, email, line) {
            document.getElementById('appCaseId').value = id;
            document.getElementById('appName').value = name;
            document.getElementById('appDate').value = '';
            document.getElementById('appNote').value = '';
            new bootstrap.Modal(document.getElementById('appointmentModal')).show();
        }

        window.saveAppointment = function() {
            const id = document.getElementById('appCaseId').value;
            const date = document.getElementById('appDate').value;
            const note = document.getElementById('appNote').value;
            
            if(!date) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢");
                return;
            }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    action: 'save_appointment',
                    id: id,
                    date: date,
                    note: note
                })
            })
            .then(() => {
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                bootstrap.Modal.getInstance(document.getElementById('appointmentModal')).hide();
                loadDashboardData();
            })
            .catch(e => {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e);
            })
            .finally(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }

        // Chat
        window.toggleChat = () => {
            const w = document.getElementById('chatWindow');
            w.style.display = w.style.display === 'flex' ? 'none' : 'flex';
        }

        window.sendChat = async () => {
            const inp = document.getElementById('chatMsg');
            const msg = inp.value.trim();
            if(!msg) return;
            
            const body = document.getElementById('chatBody');
            body.innerHTML += `<div class="message user">${msg}</div>`;
            inp.value = '';
            body.scrollTop = body.scrollHeight;
            
            try {
                const model = getGenAI().getGenerativeModel({ model: "gemini-2.0-flash-exp" });
                const prompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏î‡πá‡∏Å‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏™‡∏±‡πâ‡∏ô (ADHD) ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏£‡∏π‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢:\n\n${msg}`;
                const res = await model.generateContent(prompt);
                const aiText = res.response.text();
                body.innerHTML += `<div class="message ai">${aiText}</div>`;
                body.scrollTop = body.scrollHeight;
            } catch(e) {
                body.innerHTML += `<div class="message ai">‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>`;
            }
        }

        // Enter to send chat
        document.getElementById('chatMsg').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                sendChat();
            }
        });

    </script>
</body>
</html>
