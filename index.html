<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบคัดกรองเด็กสมาธิสั้น - รพ.หนองสองห้อง</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"/>
    
    <style>
        :root {
            --primary-pink: #FF69B4;
            --soft-pink: #FFB6C1;
            --dark-pink: #C71585;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
            --hover-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        * {
            font-family: 'Sarabun', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #ffeef8 0%, #fff5f8 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Navbar Styles */
        .navbar-custom {
            background: linear-gradient(135deg, var(--dark-pink), #8B008B);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* Header Section */
        .header-section {
            background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
            color: white;
            padding: 40px 0;
            border-radius: 0 0 50px 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 15s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .header-section h1 {
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        /* Card Styles */
        .card-custom {
            border: none;
            border-radius: 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            background: white;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .card-header-custom {
            background: linear-gradient(135deg, var(--soft-pink), var(--primary-pink));
            color: white;
            font-weight: 600;
            padding: 20px 25px;
            border: none;
            font-size: 1.1rem;
        }

        .card-header-custom i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        /* Menu Button Styles */
        .menu-card {
            border-radius: 30px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            height: 100%;
        }

        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.3));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .menu-card:hover::before {
            opacity: 1;
        }

        .menu-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .menu-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Form Styles */
        .form-label {
            font-weight: 600;
            color: var(--dark-pink);
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border-radius: 15px;
            border: 2px solid #e9ecef;
            padding: 12px 18px;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-pink);
            box-shadow: 0 0 0 0.2rem rgba(255, 105, 180, 0.15);
        }

        /* Button Styles */
        .btn-custom {
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            border: none;
        }

        .btn-outline-pink {
            color: var(--dark-pink);
            border: 2px solid var(--primary-pink);
            background: white;
        }

        .btn-outline-pink:hover,
        .btn-check:checked + .btn-outline-pink {
            background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.3);
        }

        /* Question Card Styles */
        .question-item {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .question-item:hover {
            border-color: var(--soft-pink);
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.1);
        }

        .question-text {
            font-weight: 600;
            color: #555;
            font-size: 1.05rem;
            margin-bottom: 15px;
        }

        /* Map Styles */
        #map {
            height: 500px;
            width: 100%;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .spinner-custom {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Chat Styles */
        .floating-chat-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--dark-pink), #8B008B);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 5px 20px rgba(199, 21, 133, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
        }

        .floating-chat-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 8px 25px rgba(199, 21, 133, 0.5);
        }

        .chat-window {
            position: fixed;
            bottom: 110px;
            right: 30px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--dark-pink), #8B008B);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .chat-body {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 20px;
            max-width: 80%;
            font-size: 0.95rem;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: linear-gradient(135deg, var(--soft-pink), var(--primary-pink));
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.ai {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 5px;
        }

        /* Dashboard Styles */
        .stat-card {
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            color: white;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .stat-card h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin: 0;
        }

        /* Table Styles */
        .table-custom {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .table-custom thead {
            background: linear-gradient(135deg, var(--soft-pink), var(--primary-pink));
            color: white;
        }

        .table-custom thead th {
            border: none;
            padding: 18px 15px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .table-custom tbody tr {
            transition: all 0.3s;
            border-bottom: 1px solid #f0f0f0;
        }

        .table-custom tbody tr:hover {
            background: linear-gradient(135deg, #fff5f8, #ffeef8);
            transform: scale(1.01);
        }

        .badge-custom {
            padding: 8px 15px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* Expandable Table */
        .cursor-pointer {
            cursor: pointer;
        }
        
        .cursor-pointer:hover {
            background-color: rgba(13, 110, 253, 0.1) !important;
        }
        
        .village-row {
            background-color: #f8f9fa;
        }
        
        .village-row:hover {
            background-color: #e9ecef;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
        }

        .filter-section .form-control,
        .filter-section .form-select {
            border-radius: 10px;
        }

        /* Login Overlay */
        .login-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .login-card {
            background: white;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
            border: 3px solid var(--primary-pink);
            max-width: 400px;
            width: 100%;
        }

        .blur-content {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }

        /* History Modal */
        .history-timeline {
            position: relative;
            padding-left: 30px;
        }

        .history-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--primary-pink), var(--dark-pink));
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid var(--primary-pink);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -36px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-pink);
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--primary-pink);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-section h1 { font-size: 1.8rem; }
            .menu-icon { font-size: 2.5rem; }
            .chat-window { width: 90%; right: 5%; }
            .stat-card h1 { font-size: 2.5rem; }
        }

        /* Section Display */
        #assessmentSection, #dashboardSection { display: none; }
        #landingSection { display: block; }

        /* Smooth Animations */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-custom"></div>
        <h4 class="mt-4" style="color: var(--dark-pink);">กำลังประมวลผล...</h4>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom sticky-top">
        <div class="container">
            <a class="navbar-brand animate__animated animate__fadeIn" href="#" onclick="showSection('landing')">
                <i class="fas fa-heartbeat me-2"></i>ADHD Screening System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('landing')">
                            <i class="fas fa-home me-1"></i>หน้าแรก
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('assessment')">
                            <i class="fas fa-clipboard-list me-1"></i>แบบประเมิน
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('dashboard')">
                            <i class="fas fa-chart-line me-1"></i>Dashboard
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="header-section text-center animate__animated animate__fadeIn">
        <div class="container">
            <h1><i class="fas fa-hospital me-3"></i>โรงพยาบาลหนองสองห้อง</h1>
            <p class="lead mb-0 mt-2">จังหวัดขอนแก่น - ระบบคัดกรองเด็กสมาธิสั้น (ADHD Screening System)</p>
            <p class="mt-2"><i class="fas fa-brain me-2"></i>ระบบประเมินพร้อม AI วิเคราะห์และให้คำแนะนำ</p>
            <p class="mt-2">น.ส.ทิพย์สุดา อามาตย์ พยาบาลวิชาชีพชำนาญการ กลุ่มงานจิตเวชและยาเสพติด</p>
        </div>
    </div>

    <div class="container pb-5">
        
        <!-- SECTION 1: LANDING PAGE -->
        <div id="landingSection" class="animate-fade-in">
            <div class="text-center mb-5">
                <h2 style="color: var(--dark-pink); font-weight: 700;">
                    <i class="fas fa-hand-holding-heart me-2"></i>ยินดีต้อนรับเข้าสู่ระบบประเมิน
                </h2>
                <p class="text-muted fs-5">ระบบนี้ช่วยคัดกรองความเสี่ยงสมาธิสั้นในเด็ก พร้อมคำแนะนำเบื้องต้นจาก AI</p>
            </div>

            <div class="row g-4 justify-content-center mb-5">
                <div class="col-lg-4 col-md-6">
                    <div class="card menu-card text-white h-100 animate__animated animate__fadeInUp" 
                         style="background: linear-gradient(135deg, #FF69B4, #FF1493);" 
                         onclick="showSection('assessment')">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-clipboard-list menu-icon"></i>
                            <h3 class="fw-bold">แบบประเมิน SNAP-IV</h3>
                            <p class="mb-0">สำหรับผู้ปกครอง ครู และ อสม.<br>เพื่อประเมินความเสี่ยงของเด็ก</p>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-6">
                    <div class="card menu-card text-white h-100 animate__animated animate__fadeInUp animate__delay-1s" 
                         style="background: linear-gradient(135deg, #20B2AA, #008B8B);" 
                         onclick="showSection('dashboard')">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-chart-bar menu-icon"></i>
                            <h3 class="fw-bold">Dashboard ติดตามผล</h3>
                            <p class="mb-0">สำหรับเจ้าหน้าที่สาธารณสุข<br>ดูสถิติและจัดการข้อมูล</p>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-6">
                    <div class="card menu-card text-white h-100 animate__animated animate__fadeInUp animate__delay-2s" 
                         style="background: linear-gradient(135deg, #9370DB, #663399);" 
                         onclick="toggleChat()">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-robot menu-icon"></i>
                            <h3 class="fw-bold">ปรึกษา AI ผู้ช่วย</h3>
                            <p class="mb-0">สอบถามข้อมูลหรือขอคำแนะนำ<br>เกี่ยวกับพัฒนาการเด็ก</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card card-custom animate__animated animate__fadeInUp">
                <div class="card-body p-4">
                    <h5 style="color: var(--dark-pink);" class="mb-3">
                        <i class="fas fa-info-circle me-2"></i>คำแนะนำการใช้งาน
                    </h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check-circle text-success me-3 mt-1 fs-5"></i>
                                <div>
                                    <strong>แบบประเมิน</strong>
                                    <p class="text-muted mb-0 small">คัดกรองเด็กนักเรียนหรือบุตรหลาน ใช้เวลาประมาณ 5-10 นาที</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check-circle text-info me-3 mt-1 fs-5"></i>
                                <div>
                                    <strong>Dashboard</strong>
                                    <p class="text-muted mb-0 small">ดูสถิติภาพรวมและจัดการนัดหมาย (ต้อง Login)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check-circle text-warning me-3 mt-1 fs-5"></i>
                                <div>
                                    <strong>AI ผู้ช่วย</strong>
                                    <p class="text-muted mb-0 small">ถามข้อสงสัยได้ตลอด 24 ชั่วโมง</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: ASSESSMENT FORM -->
        <div id="assessmentSection">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 style="color: var(--dark-pink);" class="fw-bold">
                    <i class="fas fa-clipboard-check me-2"></i>แบบประเมินพฤติกรรม SNAP-IV
                </h3>
                <button class="btn btn-outline-secondary rounded-pill" onclick="showSection('landing')">
                    <i class="fas fa-arrow-left me-2"></i>กลับหน้าหลัก
                </button>
            </div>

            <form id="assessmentForm">
                <!-- ข้อมูลผู้ประเมิน -->
                <div class="card card-custom animate-slide-up">
                    <div class="card-header-custom">
                        <i class="fas fa-user-nurse"></i>ข้อมูลผู้ประเมิน
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">ผู้ประเมิน <span class="text-danger">*</span></label>
                                <select class="form-select" id="evaluatorType" required>
                                    <option value="">เลือกประเภทผู้ประเมิน...</option>
                                    <option value="ครู">ครูประจำชั้น</option>
                                    <option value="ผู้ปกครอง">ผู้ปกครอง</option>
                                    <option value="รพ.สต.">เจ้าหน้าที่ รพ.สต.</option>
                                    <option value="อสม.">อสม.</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ชื่อ-สกุล <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="evaluatorName" placeholder="ระบุชื่อ-สกุล" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">เบอร์โทรศัพท์ <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="evaluatorPhone" placeholder="0xx-xxx-xxxx" required>
                            </div>
                        </div>
                    </div>
                </div>
<!-- เพิ่มก่อนส่วนข้อมูลเด็ก -->
<div class="card card-custom mb-4 animate-slide-up">
    <div class="card-header-custom">
        <i class="fas fa-search me-2"></i>ค้นหาเด็กที่เคยประเมินแล้ว
    </div>
    <div class="card-body">
        <div class="alert alert-info border-0 mb-3" style="border-radius: 15px;">
            <i class="fas fa-info-circle me-2"></i>
            <strong>คำแนะนำ:</strong> หากเด็กเคยประเมินแล้ว สามารถค้นหาเพื่อดูประวัติและประเมินซ้ำได้
            โดยระบบจะนำข้อมูลเดิมมาใส่ให้อัตโนมัติ
        </div>
        
        <div class="row g-3 mb-3">
            <div class="col-md-8">
                <label class="form-label">
                    <i class="fas fa-search text-primary me-1"></i>ค้นหาจากชื่อหรือเลข CID
                </label>
                <input type="text" class="form-control form-control-lg" id="searchChild" 
                       placeholder="พิมพ์ชื่อเด็ก หรือเลข CID (13 หลัก) เพื่อค้นหา...">
                <small class="text-muted">
                    <i class="fas fa-lightbulb me-1"></i>สามารถพิมพ์บางส่วนของชื่อได้ เช่น "สม" จะค้นหา "สมชาย", "สมหญิง"
                </small>
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-primary btn-lg w-100" onclick="searchChildHistory()">
                    <i class="fas fa-search me-2"></i>ค้นหา
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="clearSearch()">
                    <i class="fas fa-times me-1"></i>ล้าง
                </button>
            </div>
        </div>
        
        <!-- Search Results -->
        <div id="searchResults" class="mt-3" style="display:none;">
            <hr class="my-3">
            <h6 class="text-primary mb-3">
                <i class="fas fa-list me-2"></i>ผลการค้นหา
            </h6>
            <div id="searchResultsList"></div>
        </div>
    </div>
</div>
                <!-- ข้อมูลเด็ก -->
                <div class="card card-custom animate-slide-up">
                    <div class="card-header-custom">
                        <i class="fas fa-child"></i>ข้อมูลเด็กและการติดต่อ
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">ชื่อ-สกุล เด็ก <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="childName" placeholder="ระบุชื่อ-สกุลเด็ก" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">อายุ (ปี) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="childAge" min="3" max="18" placeholder="6" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">เพศ</label>
                                <select class="form-select" id="childGender">
                                    <option value="ชาย">ชาย</option>
                                    <option value="หญิง">หญิง</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-id-card text-info me-1"></i>เลขบัตรประชาชน (CID) 13 หลัก
                                </label>
                                <input type="text" class="form-control" id="childCID" 
                                    placeholder="1234567890123" maxlength="13" pattern="[0-9]{13}">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>ใช้สำหรับค้นหาประวัติ (ไม่บังคับ แต่แนะนำ)
                                </small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">
                                    <i class="fab fa-line text-success me-1"></i>Line ID (ผู้ปกครอง)
                                </label>
                                <input type="text" class="form-control" id="lineId" placeholder="@example หรือ ID Line">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-envelope text-primary me-1"></i>Email (สำหรับรับผล/นัดหมาย)
                                </label>
                                <input type="email" class="form-control" id="emailContact" placeholder="example@email.com">
                            </div>
                        </div>

                        <h6 class="text-secondary border-bottom pb-2 mb-3">
                            <i class="fas fa-map-marker-alt me-2"></i>ที่อยู่ปัจจุบัน
                        </h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-2">
                                <label class="form-label">บ้านเลขที่ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="houseNo" placeholder="123" required>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">หมู่ที่ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="village" placeholder="1" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ตำบล <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="subDistrict" placeholder="หนองสองห้อง" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">อำเภอ</label>
                                <input type="text" class="form-control" id="district" value="หนองสองห้อง" readonly>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">จังหวัด</label>
                                <input type="text" class="form-control" id="province" value="ขอนแก่น" readonly>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="button" class="btn btn-custom btn-lg" 
                                    style="background: linear-gradient(135deg, #4285F4, #1976D2); color: white;"
                                    onclick="openMapModal()">
                                <i class="fas fa-map-marked-alt me-2"></i>ปักหมุดตำแหน่งบ้านบนแผนที่
                            </button>
                            <div class="mt-3">
                                <span id="locationStatus" class="badge bg-secondary">
                                    <i class="fas fa-info-circle me-1"></i>ยังไม่ได้ระบุตำแหน่ง
                                </span>
                            </div>
                        </div>
                        <input type="hidden" id="lat">
                        <input type="hidden" id="lng">
                    </div>
                </div>
                <!-- คำแนะนำการประเมิน -->
                <div class="alert alert-info border-0 shadow-sm animate-slide-up" style="border-radius: 20px;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle fs-3 me-3"></i>
                        <div>
                            <h6 class="mb-1 fw-bold">เกณฑ์การให้คะแนน</h6>
                            <p class="mb-0">
                                <span class="badge bg-success me-2">0 = ไม่เลย</span>
                                <span class="badge bg-info me-2">1 = เล็กน้อย</span>
                                <span class="badge bg-warning me-2">2 = ค่อนข้างมาก</span>
                                <span class="badge bg-danger">3 = มาก</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- คำถามแบบประเมิน -->
                <div class="card card-custom animate-slide-up">
                    <div class="card-header-custom">
                        <i class="fas fa-tasks"></i>ส่วนที่ 1: อาการขาดสมาธิ (Inattention)
                    </div>
                    <div class="card-body p-4" id="section1-container"></div>
                </div>

                <div class="card card-custom animate-slide-up">
                    <div class="card-header-custom">
                        <i class="fas fa-running"></i>ส่วนที่ 2: อาการซน/อยู่ไม่นิ่ง (Hyperactivity)
                    </div>
                    <div class="card-body p-4" id="section2-container"></div>
                </div>

                <div class="card card-custom animate-slide-up">
                    <div class="card-header-custom">
                        <i class="fas fa-hand-paper"></i>ส่วนที่ 3: อาการดื้อ/ต่อต้าน (Oppositional Defiant)
                    </div>
                    <div class="card-body p-4" id="section3-container"></div>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-custom btn-lg text-white" 
                            style="background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));">
                        <i class="fas fa-paper-plane me-2"></i>ประมวลผลด้วย AI และส่งข้อมูลเพื่อบันทึก
                    </button>
                </div>
            </form>
        </div>

        <!-- SECTION 3: DASHBOARD -->
        <div id="dashboardSection">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 style="color: var(--dark-pink);" class="fw-bold">
                    <i class="fas fa-chart-line me-2"></i>Dashboard ติดตามผล
                </h3>
                <div>
                    <button class="btn btn-outline-secondary rounded-pill me-2" onclick="showSection('landing')">
                        <i class="fas fa-home me-1"></i>หน้าแรก
                    </button>
                    <button id="logoutBtn" class="btn btn-danger rounded-pill" onclick="logout()" style="display:none;">
                        <i class="fas fa-sign-out-alt me-1"></i>ออกจากระบบ
                    </button>
                </div>
            </div>
            
            <!-- Stats Cards (Always Visible) -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <h3><i class="fas fa-users me-2"></i>ทั้งหมด</h3>
                        <h1 id="statTotal">0</h1>
                        <small>ผู้เข้ารับการประเมิน</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <h3><i class="fas fa-exclamation-triangle me-2"></i>เสี่ยงสูง</h3>
                        <h1 id="statRisk">0</h1>
                        <small>ต้องติดตามพิเศษ</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                        <h3><i class="fas fa-check-circle me-2"></i>ปกติ</h3>
                        <h1 id="statNormal">0</h1>
                        <small>ไม่มีความเสี่ยง</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                        <h3><i class="fas fa-calendar-check me-2"></i>นัดหมายวันนี้</h3>
                        <h1 id="statToday">0</h1>
                        <small>รายการนัดหมาย</small>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-header-custom">
                            <i class="fas fa-chart-line me-2"></i>กราฟแสดงอายุ (0-12 ปี)
                        </div>
                        <div class="card-body">
                            <canvas id="ageChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card card-custom">
                        <div class="card-header-custom">
                            <i class="fas fa-chart-bar me-2"></i>กราฟแสดงเพศ
                        </div>
                        <div class="card-body">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Location Tables -->
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <div class="card card-custom">
                        <div class="card-header-custom">
                            <i class="fas fa-map-marker-alt me-2"></i>สถิติตามพื้นที่ (คลิกที่ตำบลเพื่อดูหมู่บ้าน)
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 40%;">พื้นที่</th>
                                            <th class="text-center">จำนวน</th>
                                            <th class="text-center">ร้อยละ</th>
                                            <th class="text-center">เสี่ยง</th>
                                            <th class="text-center">ปกติ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="locationTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Login Button (When not logged in) -->
            <div class="text-center mb-4" id="loginPrompt">
                <div class="alert alert-info d-inline-block" style="border-radius: 20px;">
                    <i class="fas fa-info-circle me-2"></i>
                    เข้าสู่ระบบเพื่อดูรายชื่อและจัดการข้อมูล
                    <button class="btn btn-primary ms-3 rounded-pill" onclick="showLoginModal()">
                        <i class="fas fa-sign-in-alt me-2"></i>เข้าสู่ระบบ
                    </button>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="filter-section" id="filterSection" style="display:none;">
                <h5 class="mb-3"><i class="fas fa-filter me-2"></i>ค้นหาและกรองข้อมูล</h5>
                <div class="row g-3">
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="searchName" placeholder="ค้นหาชื่อเด็ก...">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterRisk">
                            <option value="">ทุกระดับความเสี่ยง</option>
                            <option value="เสี่ยง">เสี่ยงสูง</option>
                            <option value="ปกติ">ปกติ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="filterEvaluator">
                            <option value="">ทุกประเภทผู้ประเมิน</option>
                            <option value="ครู">ครู</option>
                            <option value="ผู้ปกครอง">ผู้ปกครอง</option>
                            <option value="รพ.สต.">รพ.สต.</option>
                            <option value="อสม.">อสม.</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="filterSubdistrict" placeholder="ตำบล...">
                    </div>
                    <div class="col-md-2">
                        <input type="date" class="form-control" id="filterDate">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="applyFilter()">
                            <i class="fas fa-search me-2"></i>ค้นหา
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div id="tableContainer" style="display:none;">
                <div class="card card-custom p-0">
                    <div class="p-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-list me-2"></i>รายชื่อผู้เข้ารับการประเมิน
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle table-custom mb-0">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-calendar me-1"></i>วันที่</th>
                                        <th><i class="fas fa-user me-1"></i>ชื่อเด็ก (CID)</th>
                                        <th><i class="fas fa-user-tie me-1"></i>ผู้ประเมิน</th>
                                        <th><i class="fas fa-chart-bar me-1"></i>ผลประเมิน</th>
                                        <th><i class="fas fa-stethoscope me-1"></i>การวินิจฉัย</th>
                                        <th><i class="fas fa-pills me-1"></i>ยาที่จ่าย</th>
                                        <th><i class="fas fa-redo me-1"></i>จำนวนครั้ง</th>
                                        <th><i class="fas fa-calendar-alt me-1"></i>นัดหมาย</th>
                                        <th><i class="fas fa-map me-1"></i>แผนที่</th>
                                        <th><i class="fas fa-cog me-1"></i>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboardTableBody">
                                    <!-- Data rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 25px;">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--dark-pink), #8B008B);">
                    <h5 class="modal-title text-white fw-bold">
                        <i class="fas fa-lock me-2"></i>เข้าสู่ระบบ
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center mb-4">
                        <i class="fas fa-user-shield fs-1 mb-3" style="color: var(--dark-pink);"></i>
                        <p class="text-muted">กรุณาเข้าสู่ระบบเพื่อดูรายชื่อและจัดการข้อมูล</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ชื่อผู้ใช้</label>
                        <input type="text" id="loginUser" class="form-control" placeholder="Username">
                    </div>
                    <div class="mb-4">
                        <label class="form-label">รหัสผ่าน</label>
                        <input type="password" id="loginPass" class="form-control" placeholder="Password">
                    </div>
                    <button class="btn btn-custom w-100 text-white" 
                            style="background: linear-gradient(135deg, var(--dark-pink), #8B008B);" 
                            onclick="doLogin()">
                        <i class="fas fa-sign-in-alt me-2"></i>เข้าสู่ระบบ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div class="modal fade" id="mapModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="border-radius: 25px; overflow: hidden;">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #4285F4, #1976D2);">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-map-marked-alt me-2"></i>ระบุตำแหน่งบ้านบนแผนที่ดาวเทียม
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="p-3 bg-light">
                        <input type="text" id="mapSearchInput" class="form-control" 
                               placeholder="🔍 ค้นหาสถานที่ เช่น บ้าน ตำบล อำเภอ..." 
                               style="border-radius: 20px;">
                    </div>
                    <div id="map"></div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            ลากหมุดสีแดงไปยังตำแหน่งบ้าน หรือคลิกบนแผนที่เพื่อเปลี่ยนตำแหน่ง
                        </small>
                    </div>
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>ยกเลิก
                    </button>
                    <button type="button" class="btn btn-primary rounded-pill" onclick="confirmLocation()">
                        <i class="fas fa-check me-2"></i>บันทึกตำแหน่งนี้
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content" style="border-radius: 25px;">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--soft-pink), var(--primary-pink));">
                    <h5 class="modal-title text-white fw-bold">
                        <i class="fas fa-history me-2"></i>ประวัติการประเมิน
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6 id="historyChildName" class="fw-bold"></h6>
                        <small class="text-muted" id="historyChildInfo"></small>
                    </div>
                    <div class="history-timeline" id="historyTimeline">
                        <!-- Timeline items will be inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Modal -->
    <div class="modal fade" id="appointmentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 25px;">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));">
                    <h5 class="modal-title text-white fw-bold">
                        <i class="fas fa-calendar-plus me-2"></i>นัดหมายติดตามอาการ
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="appCaseId">
                    <div class="mb-3">
                        <label class="form-label fw-bold">ชื่อเด็ก</label>
                        <input type="text" id="appName" class="form-control" readonly style="background-color: #f8f9fa;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">วันที่นัดหมาย</label>
                        <input type="date" id="appDate" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">รายละเอียด/สิ่งที่ต้องเตรียม</label>
                        <textarea id="appNote" class="form-control" rows="4" placeholder="ระบุรายละเอียดการนัดหมาย..."></textarea>
                    </div>
                    <div class="alert alert-warning border-0" style="border-radius: 15px;">
                        <i class="fas fa-envelope me-2"></i>
                        <small>ระบบจะเตรียมข้อมูลสำหรับส่ง Email หรือ Line ให้ผู้ปกครอง</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary rounded-pill" onclick="saveAppointment()">
                        <i class="fas fa-save me-2"></i>บันทึกนัดหมาย
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content" style="border-radius: 25px;">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-clipboard-check me-2"></i>ผลการประเมินและคำแนะนำจาก AI
                    </h5>
                </div>
                <div class="modal-body p-4">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm" style="border-radius: 20px;">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3" style="color: var(--dark-pink);">
                                        <i class="fas fa-chart-bar me-2"></i>คะแนนแต่ละด้าน
                                    </h6>
                                    <div class="mb-2 d-flex justify-content-between align-items-center">
                                        <span>ขาดสมาธิ:</span>
                                        <span class="badge bg-primary fs-6 px-3 py-2" id="res-score1">0</span>
                                    </div>
                                    <div class="mb-2 d-flex justify-content-between align-items-center">
                                        <span>ซน/หุนหัน:</span>
                                        <span class="badge bg-info fs-6 px-3 py-2" id="res-score2">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>ดื้อ/ต่อต้าน:</span>
                                        <span class="badge bg-warning fs-6 px-3 py-2" id="res-score3">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm" style="border-radius: 20px; background: linear-gradient(135deg, #ffeef8, #fff5f8);">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3" style="color: var(--dark-pink);">
                                        <i class="fas fa-stethoscope me-2"></i>สรุปผลการประเมิน
                                    </h6>
                                    <p id="res-basic-summary" class="fw-bold fs-5 mb-0">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <h5 style="color: var(--dark-pink);" class="fw-bold mb-3">
                        <i class="fas fa-robot me-2"></i>คำแนะนำจาก AI
                    </h5>
                    <div id="ai-analysis-content" class="p-4 rounded" style="background-color: #f8f9fa; border-left: 4px solid var(--primary-pink);">
                        <!-- AI content will be inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" onclick="window.location.reload()">
                        <i class="fas fa-times me-1"></i>ปิด
                    </button>
                    <button type="button" class="btn btn-primary rounded-pill" 
                            style="background: linear-gradient(135deg, var(--dark-pink), #8B008B); border: none;" 
                            onclick="confirmSaveToSheet()">
                        <i class="fas fa-save me-2"></i>บันทึกข้อมูล
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Chat -->
    <div class="floating-chat-btn" onclick="toggleChat()">
        <i class="fas fa-robot"></i>
    </div>
    
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <span><i class="fas fa-robot me-2"></i>AI ผู้ช่วย</span>
            <button class="btn btn-sm text-white" onclick="toggleChat()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="message ai">
                <strong>สวัสดีค่ะ 👋</strong><br>
                ฉันคือ AI ผู้ช่วย พร้อมตอบคำถามเกี่ยวกับการพัฒนาการเด็กและสมาธิสั้นค่ะ
            </div>
        </div>
        <div class="input-group p-3" style="background: #f8f9fa;">
            <input type="text" class="form-control" id="chatMsg" placeholder="พิมพ์ข้อความ..." 
                   style="border-radius: 20px 0 0 20px;">
            <button class="btn btn-primary" onclick="sendChat()" style="border-radius: 0 20px 20px 0;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    <!-- เพิ่ม Modal สำหรับบันทึกการวินิจฉัยและยา (ใส่ก่อน </body>) -->

<!-- Diagnosis & Medication Modal -->
<div class="modal fade" id="diagnosisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 20px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 20px 20px 0 0;">
                <h5 class="modal-title">
                    <i class="fas fa-stethoscope me-2"></i>บันทึกการวินิจฉัยและการรักษา
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="diagnosisRecordID">
                
                <div class="alert alert-light border mb-4" style="border-radius: 15px;">
                    <h6 class="mb-1">
                        <i class="fas fa-user-circle me-2 text-primary"></i>ชื่อเด็ก
                    </h6>
                    <p class="mb-0 fw-bold fs-5" id="diagnosisChildName"></p>
                </div>
                
                <div class="mb-4">
                    <label class="form-label fw-bold">
                        <i class="fas fa-notes-medical text-primary me-2"></i>การวินิจฉัย
                    </label>
                    <textarea class="form-control" id="diagnosisInput" rows="4" 
                              placeholder="ระบุผลการวินิจฉัยจากแพทย์&#10;&#10;ตัวอย่าง:&#10;- ADHD Combined Type&#10;- ADHD Inattentive Type&#10;- ADHD Hyperactive-Impulsive Type"></textarea>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>ข้อมูลจากแพทย์เท่านั้น
                    </small>
                </div>
                
                <div class="mb-4">
                    <label class="form-label fw-bold">
                        <i class="fas fa-pills text-success me-2"></i>ยาที่จ่าย
                    </label>
                    <textarea class="form-control" id="medicationInput" rows="4" 
                              placeholder="ระบุชื่อยาและขนาด&#10;&#10;ตัวอย่าง:&#10;- Methylphenidate 10 mg วันละ 2 ครั้ง (เช้า-กลางวัน)&#10;- Atomoxetine 25 mg วันละ 1 ครั้ง (เช้า)&#10;- Concerta 18 mg วันละ 1 ครั้ง (เช้า)"></textarea>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>ระบุรายละเอียดยาที่ได้รับ
                    </small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-calendar-alt text-info me-2"></i>วันที่จ่ายยา
                    </label>
                    <input type="date" class="form-control form-control-lg" id="medicationDateInput">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>ระบุวันที่เริ่มได้รับยา
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ยกเลิก
                </button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="saveDiagnosis()">
                    <i class="fas fa-save me-2"></i>บันทึก
                </button>
            </div>
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA1xmTQ_hd4n-FPyqIiUqPhAElgMRdYfUo&libraries=places&callback=initMap"></script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Configuration
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxn5cPOIXfkd9YiQJBuxFs8XVxKnn_aioeTytsrWVZk0oZSwYC8ogWpP5Z-uTckpS7x/exec";
        const AI_KEYS = [
            "AIzaSyDiqXPAnfMICeehtGSC6VwDJaH9HqTIa-E",
            "AIzaSyAuGmhGGfVIgdcBS-bDPu06I_fQpIy2Sng",
            "AIzaSyAXn2RnKle5RdJsD74PHVQbQAcOkPffkb4"
        ];
        
        let currentKeyIndex = 0;
        function getGenAI() {
            const key = AI_KEYS[currentKeyIndex];
            currentKeyIndex = (currentKeyIndex + 1) % AI_KEYS.length;
            return new GoogleGenerativeAI(key);
        }

        // Global Variables
        let map, marker, finalData = {};
        let allCases = [];
        let filteredCases = [];
        let isLoggedIn = false;
        let ageChart = null;
        let genderChart = null;
        let mapInitialized = false;

        // Map Initialization
        window.initMap = function() {
            // Don't initialize until called
            console.log('Google Maps API loaded');
        }

        function actuallyInitMap() {
            if(mapInitialized) return;
            
            const hospitalPos = { lat: 15.73315086491515, lng: 102.79444248459548 };
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 18,
                center: hospitalPos,
                mapTypeId: 'satellite',
                streetViewControl: false,
                fullscreenControl: true
            });

            marker = new google.maps.Marker({
                position: hospitalPos,
                map: map,
                draggable: true,
                title: "ตำแหน่งบ้าน (ลากเพื่อแก้ไข)",
                animation: google.maps.Animation.DROP
            });

            // Add Search Box
            const input = document.getElementById('mapSearchInput');
            const searchBox = new google.maps.places.SearchBox(input);
            
            // Bias search to map viewport
            map.addListener('bounds_changed', function() {
                searchBox.setBounds(map.getBounds());
            });

            // Listen for search box places changed
            searchBox.addListener('places_changed', function() {
                const places = searchBox.getPlaces();
                if (places.length == 0) return;
                
                const place = places[0];
                if (!place.geometry || !place.geometry.location) return;
                
                // Move marker to searched location
                marker.setPosition(place.geometry.location);
                map.setCenter(place.geometry.location);
                map.setZoom(18);
            });

            // Click to move marker
            map.addListener('click', function(e) {
                marker.setPosition(e.latLng);
            });

            document.getElementById("lat").value = hospitalPos.lat;
            document.getElementById("lng").value = hospitalPos.lng;
            
            mapInitialized = true;
        }

        window.openMapModal = function() {
            const modal = new bootstrap.Modal(document.getElementById('mapModal'));
            modal.show();
            
            // Initialize map when modal opens
            setTimeout(function() {
                if(!mapInitialized) {
                    actuallyInitMap();
                }
                // Trigger resize to fix display issues
                if(map) {
                    google.maps.event.trigger(map, 'resize');
                    map.setCenter(marker.getPosition());
                }
            }, 500);
        }

        window.confirmLocation = function() {
            const pos = marker.getPosition();
            document.getElementById("lat").value = pos.lat();
            document.getElementById("lng").value = pos.lng();
            
            document.getElementById("locationStatus").innerHTML = 
                `<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>บันทึกพิกัดแล้ว: ${pos.lat().toFixed(5)}, ${pos.lng().toFixed(5)}</span>`;
            
            bootstrap.Modal.getInstance(document.getElementById('mapModal')).hide();
        }

        // Questions Rendering
        const questions = [
            {id: 1, text: "มักไม่ละเอียดรอบคอบ ทำอะไรผิดพลาดบ่อย", section: 1},
            {id: 2, text: "ทำกิจกรรมนานๆ ไม่ได้ สมาธิสั้น", section: 1},
            {id: 3, text: "ไม่ค่อยฟังเวลาพูดด้วย ใจลอย", section: 1},
            {id: 4, text: "ทำงานไม่เสร็จตามที่มอบหมาย", section: 1},
            {id: 5, text: "จัดระเบียบไม่เป็น ของกระจัดกระจาย", section: 1},
            {id: 6, text: "เลี่ยงงานที่ใช้ความอดทน", section: 1},
            {id: 7, text: "ทำของหายบ่อย ลืมของตลอด", section: 1},
            {id: 8, text: "วอกแวกง่าย เสียสมาธิง่าย", section: 1},
            {id: 9, text: "ขี้ลืม หลงลืมกิจกรรมประจำวัน", section: 1},
            {id: 10, text: "มือเท้ายุกยิก ไม่หยุดนิ่ง", section: 2},
            {id: 11, text: "นั่งไม่ติดที่ ลุกขึ้นยืนบ่อย", section: 2},
            {id: 12, text: "วิ่งไปวิ่งมา ปีนป่ายไม่รู้กาลเทศะ", section: 2},
            {id: 13, text: "เล่นเงียบๆ ไม่เป็น เสียงดังเสมอ", section: 2},
            {id: 14, text: "เหมือนติดเครื่องตลอดเวลา", section: 2},
            {id: 15, text: "พูดมาก พูดไม่หยุด", section: 2},
            {id: 16, text: "พูดโพล่งก่อนคำถามจบ", section: 2},
            {id: 17, text: "ไม่ชอบรอคิว แย่งคิวคนอื่น", section: 2},
            {id: 18, text: "ชอบสอดแทรก ขัดจังหวะคนอื่น", section: 2},
            {id: 19, text: "อารมณ์เสียง่าย โมโหง่าย", section: 3},
            {id: 20, text: "เถียงผู้ใหญ่ ไม่เคารพ", section: 3},
            {id: 21, text: "ไม่ทำตามกฎ ฝ่าฝืนกฎระเบียบ", section: 3},
            {id: 22, text: "จงใจกวนประสาทคนอื่น", section: 3},
            {id: 23, text: "โทษคนอื่นเสมอเมื่อทำผิด", section: 3},
            {id: 24, text: "ขี้รำคาญ หงุดหงิดง่าย", section: 3},
            {id: 25, text: "โกรธปึงปัง ขี้โมโห", section: 3},
            {id: 26, text: "เจ้าคิดเจ้าแค้น พยาบาท", section: 3}
        ];

        questions.forEach(q => {
            const container = document.getElementById(`section${q.section}-container`);
            const div = document.createElement("div");
            div.className = "question-item";
            div.innerHTML = `
                <p class="question-text">
                    <span class="badge bg-secondary me-2">${q.id}</span>
                    ${q.text}
                </p>
                <div class="d-flex gap-2 flex-wrap">
                    ${[0,1,2,3].map(v => `
                        <input type="radio" class="btn-check" name="q${q.id}" id="q${q.id}_${v}" value="${v}" required>
                        <label class="btn btn-outline-pink flex-fill" for="q${q.id}_${v}">
                            ${['ไม่เลย (0)','เล็กน้อย (1)','ค่อนข้างมาก (2)','มาก (3)'][v]}
                        </label>
                    `).join('')}
                </div>
            `;
            container.appendChild(div);
        });

        // Form Submit
        document.getElementById('assessmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            let s1 = 0, s2 = 0, s3 = 0, answers = {}, highRisk = [];
            
            questions.forEach(q => {
                const val = parseInt(formData.get(`q${q.id}`));
                answers[`q${q.id}`] = val;
                if(q.section === 1) s1 += val;
                if(q.section === 2) s2 += val;
                if(q.section === 3) s3 += val;
                if(val >= 2) highRisk.push(`${q.text} (${val === 2 ? 'ค่อนข้างมาก' : 'มาก'})`);
            });

            let resultBasic = (s1 > 16 || s2 > 16 || s3 > 14) ? "มีความเสี่ยง ควรพบแพทย์" : "ปกติ";
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                const genAI = getGenAI();
                const model = genAI.getGenerativeModel({ model: "gemini-3-flash-preview" });
                
                const prompt = `วิเคราะห์ผลการประเมิน SNAP-IV สำหรับเด็กชื่อ ${document.getElementById('childName').value} อายุ ${document.getElementById('childAge').value} ปี
                
คะแนนที่ได้:
- ขาดสมาธิ: ${s1}/27 (เกณฑ์เสี่ยง > 16)
- ซน/หุนหัน: ${s2}/27 (เกณฑ์เสี่ยง > 16)
- ดื้อ/ต่อต้าน: ${s3}/24 (เกณฑ์เสี่ยง > 14)

อาการที่พบเด่นชัด:
${highRisk.join('\n')}

กรุณาให้:
1. การวิเคราะห์ผลแบบละเอียด
2. คำแนะนำในการปรับพฤติกรรมที่บ้านและโรงเรียน
3. กิจกรรมที่เหมาะสม
4. ข้อควรระวังและข้อแนะนำสำหรับผู้ปกครอง/ครู

จัดรูปแบบเป็น HTML ด้วย <ul> <li> ไม่ต้องมี markdown`;

                const result = await model.generateContent(prompt);
                const aiRes = result.response.text().replace(/```html/g, '').replace(/```/g, '').trim();

                document.getElementById('res-score1').innerText = s1;
                document.getElementById('res-score2').innerText = s2;
                document.getElementById('res-score3').innerText = s3;
                document.getElementById('res-basic-summary').innerText = resultBasic;
                document.getElementById('ai-analysis-content').innerHTML = aiRes;

                finalData = {
                    action: 'submit_assessment',
                    evaluatorType: document.getElementById('evaluatorType').value,
                    evaluatorName: document.getElementById('evaluatorName').value,
                    evaluatorPhone: document.getElementById('evaluatorPhone').value,
                    childName: document.getElementById('childName').value,
                    childAge: document.getElementById('childAge').value,
                    lineId: document.getElementById('lineId').value,
                    email: document.getElementById('emailContact').value,
                    houseNo: document.getElementById('houseNo').value,
                    village: document.getElementById('village').value,
                    subDistrict: document.getElementById('subDistrict').value,
                    district: document.getElementById('district').value,
                    province: document.getElementById('province').value,
                    lat: document.getElementById('lat').value,
                    lng: document.getElementById('lng').value,
                    diagnosis: document.getElementById('diagnosis').value || '',
                    medication: document.getElementById('medication').value || '',
                    medicationDate: document.getElementById('medicationDate').value || '',
                    ...answers,
                    scoreInattention: s1,
                    scoreHyperactivity: s2,
                    scoreOppositional: s3,
                    totalScore: s1 + s2 + s3,
                    resultText: resultBasic,
                    aiSummary: "Processed",
                    aiAdvice: aiRes
                };

                new bootstrap.Modal(document.getElementById('resultModal')).show();
                
            } catch(err) {
                alert("เกิดข้อผิดพลาดจาก AI: " + err);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });

        // Save to Sheet
        window.confirmSaveToSheet = function() {
            if(SCRIPT_URL.includes("YOUR_WEB")) {
                alert("กรุณาใส่ Web App URL");
                return;
            }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(finalData)
            })
            .then(() => {
                alert("✅ บันทึกข้อมูลสำเร็จ!");
                window.location.reload();
            })
            .catch(e => {
                alert("❌ เกิดข้อผิดพลาด: " + e);
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }

        // Section Navigation
        window.showSection = function(sec) {
            ['landingSection', 'assessmentSection', 'dashboardSection'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            if(sec === 'landing') {
                document.getElementById('landingSection').style.display = 'block';
            }
            if(sec === 'assessment') {
                document.getElementById('assessmentSection').style.display = 'block';
                window.scrollTo(0, 0);
            }
            if(sec === 'dashboard') {
                document.getElementById('dashboardSection').style.display = 'block';
                loadDashboardData();
            }
        }

        // Login
        window.showLoginModal = function() {
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        }

        window.doLogin = function() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            
            if(!u || !p) {
                alert("กรุณากรอกชื่อผู้ใช้และรหัสผ่าน");
                return;
            }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({action: 'login', username: u, password: p})
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('loadingOverlay').style.display = 'none';
                if(data.status === 'success') {
                    isLoggedIn = true;
                    
                    // Close login modal
                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    if(loginModal) {
                        loginModal.hide();
                    }
                    
                    // Update view and load data if needed
                    updateDashboardView();
                    
                    // Reload data to ensure table shows
                    if(allCases.length === 0) {
                        loadDashboardData();
                    } else {
                        renderTable(filteredCases);
                    }
                } else {
                    alert("❌ ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง");
                }
            })
            .catch(e => {
                alert("เกิดข้อผิดพลาดในการเชื่อมต่อ: " + e);
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }

        window.logout = function() {
            isLoggedIn = false;
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
            updateDashboardView();
        }

        // Dashboard
        function loadDashboardData() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({action: 'get_dashboard_data'})
            })
            .then(r => r.json())
            .then(res => {
                document.getElementById('loadingOverlay').style.display = 'none';
                if(res.status === 'success') {
                    allCases = res.data;
                    filteredCases = allCases;
                    updateStats(allCases);
                    
                    // Update view after loading data
                    updateDashboardView();
                } else {
                    console.error('Error loading data:', res);
                }
            })
            .catch(e => {
                console.error('Fetch error:', e);
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }

        function updateDashboardView() {
            const tableContainer = document.getElementById('tableContainer');
            const loginPrompt = document.getElementById('loginPrompt');
            const logoutBtn = document.getElementById('logoutBtn');
            const filterSection = document.getElementById('filterSection');

            if(isLoggedIn) {
                // User is logged in: Show table, Hide login prompt, Show logout
                tableContainer.style.display = 'block';
                loginPrompt.style.display = 'none';
                logoutBtn.style.display = 'block';
                filterSection.style.display = 'block';
                
                // Render table with current data
                if(allCases.length > 0) {
                    renderTable(filteredCases);
                }
            } else {
                // User is NOT logged in: Hide table, Show login prompt, Hide logout
                tableContainer.style.display = 'none';
                loginPrompt.style.display = 'block';
                logoutBtn.style.display = 'none';
                filterSection.style.display = 'none';
            }
        }

        function updateStats(data) {
            document.getElementById('statTotal').innerText = data.length;
            
            const riskCases = data.filter(d => d.AssessmentResult && d.AssessmentResult.includes('เสี่ยง'));
            document.getElementById('statRisk').innerText = riskCases.length;
            
            const normalCases = data.filter(d => d.AssessmentResult && d.AssessmentResult.includes('ปกติ'));
            document.getElementById('statNormal').innerText = normalCases.length;
            
            const today = new Date().toLocaleDateString('th-TH');
            const todayAppts = data.filter(d => {
                if(!d.AppointmentDate) return false;
                const apptDate = new Date(d.AppointmentDate).toLocaleDateString('th-TH');
                return apptDate === today;
            });
            document.getElementById('statToday').innerText = todayAppts.length;
            
            // Update Charts
            updateAgeChart(data);
            updateGenderChart(data);
            updateLocationTables(data);
        }

        function updateAgeChart(data) {
            // Count by age (0-12)
            const ageCounts = {};
            const ageRisk = {};
            const ageNormal = {};
            
            for(let i = 0; i <= 12; i++) {
                ageCounts[i] = 0;
                ageRisk[i] = 0;
                ageNormal[i] = 0;
            }
            
            data.forEach(item => {
                const age = parseInt(item.ChildAge);
                if(age >= 0 && age <= 12) {
                    ageCounts[age]++;
                    if(item.AssessmentResult && item.AssessmentResult.includes('เสี่ยง')) {
                        ageRisk[age]++;
                    } else {
                        ageNormal[age]++;
                    }
                }
            });
            
            const labels = [];
            const riskData = [];
            const normalData = [];
            
            for(let i = 0; i <= 12; i++) {
                labels.push(i + ' ปี');
                riskData.push(ageRisk[i]);
                normalData.push(ageNormal[i]);
            }
            
            const ctx = document.getElementById('ageChart');
            
            if(ageChart) {
                ageChart.destroy();
            }
            
            ageChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'เสี่ยง',
                        data: riskData,
                        borderColor: '#f5576c',
                        backgroundColor: 'rgba(245, 87, 108, 0.2)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'ปกติ',
                        data: normalData,
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateGenderChart(data) {
            const genderCounts = { 'ชาย': 0, 'หญิง': 0 };
            const genderRisk = { 'ชาย': 0, 'หญิง': 0 };
            const genderNormal = { 'ชาย': 0, 'หญิง': 0 };
            
            data.forEach(item => {
                const gender = (item.ChildGender && String(item.ChildGender).trim()) || 'ไม่ระบุ';
                if(gender === 'ชาย' || gender === 'หญิง') {
                    genderCounts[gender]++;
                    if(item.AssessmentResult && String(item.AssessmentResult).includes('เสี่ยง')) {
                        genderRisk[gender]++;
                    } else {
                        genderNormal[gender]++;
                    }
                }
            });
            
            const ctx = document.getElementById('genderChart');
            
            if(genderChart) {
                genderChart.destroy();
            }
            
            genderChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ชาย', 'หญิง'],
                    datasets: [{
                        label: 'เสี่ยง',
                        data: [genderRisk['ชาย'], genderRisk['หญิง']],
                        backgroundColor: '#f5576c'
                    }, {
                        label: 'ปกติ',
                        data: [genderNormal['ชาย'], genderNormal['หญิง']],
                        backgroundColor: '#4facfe'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            stacked: false
                        }
                    }
                }
            });
        }

        function updateLocationTables(data) {
            const locationTable = document.getElementById('locationTable');
            locationTable.innerHTML = '';
            
            // Group by Subdistrict and Village
            const subdistrictData = {};
            
            data.forEach(item => {
                const subdistrict = (item.SubDistrict && String(item.SubDistrict).trim()) || 'ไม่ระบุ';
                const village = (item.Village && String(item.Village).trim()) || 'ไม่ระบุ';
                
                // Initialize subdistrict
                if(!subdistrictData[subdistrict]) {
                    subdistrictData[subdistrict] = {
                        total: 0,
                        risk: 0,
                        normal: 0,
                        villages: {}
                    };
                }
                
                // Initialize village
                if(!subdistrictData[subdistrict].villages[village]) {
                    subdistrictData[subdistrict].villages[village] = {
                        total: 0,
                        risk: 0,
                        normal: 0
                    };
                }
                
                // Count
                subdistrictData[subdistrict].total++;
                subdistrictData[subdistrict].villages[village].total++;
                
                if(item.AssessmentResult && String(item.AssessmentResult).includes('เสี่ยง')) {
                    subdistrictData[subdistrict].risk++;
                    subdistrictData[subdistrict].villages[village].risk++;
                } else {
                    subdistrictData[subdistrict].normal++;
                    subdistrictData[subdistrict].villages[village].normal++;
                }
            });
            
            // Sort subdistricts
            const sortedSubdistricts = Object.keys(subdistrictData).sort();
            
            sortedSubdistricts.forEach(subdistrict => {
                const subdistrictStat = subdistrictData[subdistrict];
                const percent = ((subdistrictStat.total / data.length) * 100).toFixed(1);
                const subdistrictId = 'subdistrict_' + subdistrict.replace(/[^a-zA-Z0-9ก-๙]/g, '_');
                
                // Subdistrict row
                const trSubdistrict = document.createElement('tr');
                trSubdistrict.className = 'table-primary cursor-pointer';
                trSubdistrict.style.cursor = 'pointer';
                trSubdistrict.innerHTML = `
                    <td>
                        <i class="fas fa-chevron-right me-2" id="icon_${subdistrictId}"></i>
                        <strong>📍 ${subdistrict}</strong>
                    </td>
                    <td class="text-center"><strong>${subdistrictStat.total}</strong></td>
                    <td class="text-center"><strong>${percent}%</strong></td>
                    <td class="text-center"><span class="badge bg-danger">${subdistrictStat.risk}</span></td>
                    <td class="text-center"><span class="badge bg-success">${subdistrictStat.normal}</span></td>
                `;
                
                trSubdistrict.onclick = function() {
                    toggleVillages(subdistrictId);
                };
                
                locationTable.appendChild(trSubdistrict);
                
                // Village rows (hidden by default)
                const sortedVillages = Object.keys(subdistrictStat.villages).sort((a, b) => {
                    const numA = parseInt(a.replace(/[^0-9]/g, '')) || 0;
                    const numB = parseInt(b.replace(/[^0-9]/g, '')) || 0;
                    return numA - numB;
                });
                
                sortedVillages.forEach(village => {
                    const villageStat = subdistrictStat.villages[village];
                    const villagePercent = ((villageStat.total / subdistrictStat.total) * 100).toFixed(1);
                    
                    const trVillage = document.createElement('tr');
                    trVillage.className = 'village-row ' + subdistrictId;
                    trVillage.style.display = 'none';
                    trVillage.innerHTML = `
                        <td class="ps-5">
                            <i class="fas fa-home me-2 text-muted"></i>${village}
                        </td>
                        <td class="text-center">${villageStat.total}</td>
                        <td class="text-center">${villagePercent}%</td>
                        <td class="text-center"><span class="badge bg-danger">${villageStat.risk}</span></td>
                        <td class="text-center"><span class="badge bg-success">${villageStat.normal}</span></td>
                    `;
                    
                    locationTable.appendChild(trVillage);
                });
            });
        }
        
        function toggleVillages(subdistrictId) {
            const villages = document.querySelectorAll('.' + subdistrictId);
            const icon = document.getElementById('icon_' + subdistrictId);
            const isHidden = villages[0].style.display === 'none';
            
            villages.forEach(row => {
                row.style.display = isHidden ? 'table-row' : 'none';
            });
            
            if(icon) {
                icon.className = isHidden ? 'fas fa-chevron-down me-2' : 'fas fa-chevron-right me-2';
            }
        }

        function renderTable(data) {
    const tbody = document.getElementById('dashboardTableBody');
    if(!tbody) {
        console.error('Table body element not found!');
        return;
    }
    
    tbody.innerHTML = '';
    
    if(data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-5">ไม่พบข้อมูล</td></tr>';
        return;
    }
    
    const childGroups = {};
    data.forEach(item => {
        const name = item.ChildName;
        if(!childGroups[name]) {
            childGroups[name] = [];
        }
        childGroups[name].push(item);
    });
    
    Object.keys(childGroups).forEach(childName => {
        const assessments = childGroups[childName];
        const latest = assessments[assessments.length - 1];
        const count = assessments.length;
        
        const date = new Date(latest.Timestamp).toLocaleDateString('th-TH', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        
        const hasLine = latest.LineID && String(latest.LineID).trim() !== '';
        const hasEmail = latest.Email && String(latest.Email).trim() !== '';
        const hasPhone = latest.EvaluatorPhone && String(latest.EvaluatorPhone).trim() !== '';
        
        const escapedDiagnosis = String(latest.Diagnosis || '').replace(/'/g, "\\\\'").replace(/"/g, '&quot;');
        const escapedMedication = String(latest.Medication || '').replace(/'/g, "\\\\'").replace(/"/g, '&quot;');
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${date}</td>
            <td>
                <strong>${latest.ChildName}</strong><br>
                <small class="text-muted">
                    <i class="fas fa-id-card me-1"></i>CID: ${latest.ChildCID || 'ไม่มี'}
                </small>
            </td>
            <td>
                ${latest.EvaluatorName}<br>
                <span class="badge bg-secondary">${latest.EvaluatorType}</span>
            </td>
            <td>
                <span class="badge ${latest.AssessmentResult.includes('เสี่ยง') ? 'bg-danger' : 'bg-success'}">
                    ${latest.AssessmentResult}
                </span>
            </td>
            <td>
                ${latest.Diagnosis && String(latest.Diagnosis).trim() ? `
                    <small class="text-primary d-block mb-1">
                        <i class="fas fa-check-circle me-1"></i>${latest.Diagnosis}
                    </small>
                    <button class="btn btn-sm btn-outline-secondary" 
                            onclick='openDiagnosis("${latest.ID}", "${latest.ChildName}", "${escapedDiagnosis}", "${escapedMedication}", "${latest.MedicationDate || ''}")'>
                        <i class="fas fa-edit me-1"></i>แก้ไข
                    </button>
                ` : `
                    <button class="btn btn-sm btn-outline-primary rounded-pill" 
                            onclick='openDiagnosis("${latest.ID}", "${latest.ChildName}", "", "", "")'>
                        <i class="fas fa-plus me-1"></i>บันทึก
                    </button>
                `}
            </td>
            <td>
                ${latest.Medication && String(latest.Medication).trim() ? `
                    <small class="text-success d-block mb-1">
                        <i class="fas fa-pills me-1"></i>${latest.Medication}
                    </small>
                    ${latest.MedicationDate ? `
                        <small class="text-muted d-block mb-1">
                            <i class="fas fa-calendar me-1"></i>${new Date(latest.MedicationDate).toLocaleDateString('th-TH')}
                        </small>
                    ` : ''}
                    <button class="btn btn-sm btn-outline-secondary" 
                            onclick='openDiagnosis("${latest.ID}", "${latest.ChildName}", "${escapedDiagnosis}", "${escapedMedication}", "${latest.MedicationDate || ''}")'>
                        <i class="fas fa-edit me-1"></i>แก้ไข
                    </button>
                ` : `<small class="text-muted">ยังไม่มี</small>`}
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary rounded-pill" 
                        onclick='showHistory(${JSON.stringify(childName)})'>
                    <i class="fas fa-history me-1"></i>${count} ครั้ง
                </button>
            </td>
            <td>
                ${latest.AppointmentDate ? 
                  new Date(latest.AppointmentDate).toLocaleDateString('th-TH') : 
                  '<span class="text-muted">ยังไม่มี</span>'}
            </td>
            <td>
                ${latest.MapLat && latest.MapLng ? `
                    <a href="https://www.google.com/maps?q=${latest.MapLat},${latest.MapLng}" 
                       target="_blank" class="btn btn-sm btn-success rounded-pill">
                        <i class="fas fa-map-marked-alt"></i>
                    </a>
                ` : '<small class="text-muted">ไม่มี</small>'}
            </td>
            <td>
                <div class="d-flex flex-column gap-1" style="font-size: 0.85rem;">
                    ${hasEmail ? `
                        <div>
                            <i class="fas fa-envelope text-primary me-1"></i>
                            <a href="mailto:${latest.Email}">${latest.Email}</a>
                        </div>
                    ` : '<small class="text-muted"><i class="fas fa-envelope me-1"></i>ไม่มี</small>'}
                    
                    ${hasPhone ? `
                        <div>
                            <i class="fas fa-phone text-success me-1"></i>
                            <a href="tel:${latest.EvaluatorPhone}">${latest.EvaluatorPhone}</a>
                        </div>
                    ` : '<small class="text-muted"><i class="fas fa-phone me-1"></i>ไม่มี</small>'}
                    
                    ${hasLine ? `
                        <div>
                            <i class="fab fa-line text-success me-1"></i>
                            ${latest.LineID}
                        </div>
                    ` : '<small class="text-muted"><i class="fab fa-line me-1"></i>ไม่มี</small>'}
                    
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary w-100" 
                                onclick='openAppoint("${latest.ID}", "${latest.ChildName}", "${latest.Email || ''}", "${latest.LineID || ''}")'>
                            <i class="fas fa-calendar-plus me-1"></i>นัดหมาย
                        </button>
                    </div>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

        // Filter Function
        window.applyFilter = function() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const filterRisk = document.getElementById('filterRisk').value;
            const filterEvaluator = document.getElementById('filterEvaluator').value;
            const filterSubdistrict = document.getElementById('filterSubdistrict').value.toLowerCase();
            const filterDate = document.getElementById('filterDate').value;
            
            filteredCases = allCases.filter(item => {
                let match = true;
                
                if(searchName && (!item.ChildName || !String(item.ChildName).toLowerCase().includes(searchName))) {
                    match = false;
                }
                
                if(filterRisk && (!item.AssessmentResult || !String(item.AssessmentResult).includes(filterRisk))) {
                    match = false;
                }
                
                if(filterEvaluator && String(item.EvaluatorType) !== filterEvaluator) {
                    match = false;
                }
                
                if(filterSubdistrict && (!item.SubDistrict || !String(item.SubDistrict).toLowerCase().includes(filterSubdistrict))) {
                    match = false;
                }
                
                if(filterDate) {
                    const itemDate = new Date(item.Timestamp).toISOString().split('T')[0];
                    if(itemDate !== filterDate) {
                        match = false;
                    }
                }
                
                return match;
            });
            
            updateStats(filteredCases);
            renderTable(filteredCases);
        }

        // Show History
        window.showHistory = function(childName) {
            const childCases = allCases.filter(c => c.ChildName === childName);
            
            if(childCases.length === 0) return;
            
            const latestCase = childCases[childCases.length - 1];
            
            document.getElementById('historyChildName').innerText = childName;
            
            // Contact info - handle null/undefined safely
            const contactInfo = [];
            if(latestCase.EvaluatorPhone && String(latestCase.EvaluatorPhone).trim()) {
                contactInfo.push(`📞 ${latestCase.EvaluatorPhone}`);
            }
            if(latestCase.LineID && String(latestCase.LineID).trim()) {
                contactInfo.push(`💬 Line: ${latestCase.LineID}`);
            }
            if(latestCase.Email && String(latestCase.Email).trim()) {
                contactInfo.push(`📧 ${latestCase.Email}`);
            }
            
            document.getElementById('historyChildInfo').innerHTML = 
                `อายุ ${latestCase.ChildAge} ปี | ประวัติการประเมินทั้งหมด ${childCases.length} ครั้ง<br>` +
                (contactInfo.length > 0 ? `<small class="text-muted">${contactInfo.join(' | ')}</small>` : '<small class="text-muted">ไม่มีข้อมูลติดต่อ</small>');
            
            const timeline = document.getElementById('historyTimeline');
            timeline.innerHTML = '';
            
            childCases.reverse().forEach((item, idx) => {
                const date = new Date(item.Timestamp).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const div = document.createElement('div');
                div.className = 'timeline-item';
                
                // Clean AI advice - remove markdown code blocks
                let aiAdvice = item.AIAdvice || 'ไม่มีข้อมูล';
                aiAdvice = aiAdvice.replace(/```html/g, '').replace(/```/g, '').trim();
                
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0 fw-bold">ครั้งที่ ${childCases.length - idx}</h6>
                        <small class="text-muted">${date}</small>
                    </div>
                    <p class="mb-2">
                        <strong>ผู้ประเมิน:</strong> ${item.EvaluatorName} (${item.EvaluatorType})
                    </p>
                    
                    ${item.Diagnosis && String(item.Diagnosis).trim() ? `
                        <div class="alert alert-info py-2 mb-2" style="border-radius: 10px;">
                            <small>
                                <i class="fas fa-stethoscope me-1"></i><strong>การวินิจฉัย:</strong> ${item.Diagnosis}
                            </small>
                        </div>
                    ` : ''}
                    
                    ${item.Medication && String(item.Medication).trim() ? `
                        <div class="alert alert-success py-2 mb-2" style="border-radius: 10px;">
                            <small>
                                <i class="fas fa-pills me-1"></i><strong>ยาที่จ่าย:</strong> ${item.Medication}
                                ${item.MedicationDate ? `
                                    <br><i class="fas fa-calendar me-1"></i>วันที่จ่าย: ${new Date(item.MedicationDate).toLocaleDateString('th-TH')}
                                ` : ''}
                            </small>
                        </div>
                    ` : ''}
                    
                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <small class="text-muted">ขาดสมาธิ:</small><br>
                            <span class="badge bg-primary">${item.Score_Inattention || 0}/27</span>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">ซน/หุนหัน:</small><br>
                            <span class="badge bg-info">${item.Score_Hyperactivity || 0}/27</span>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">ดื้อ/ต่อต้าน:</small><br>
                            <span class="badge bg-warning">${item.Score_Oppositional || 0}/24</span>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <span class="badge ${item.AssessmentResult.includes('เสี่ยง') ? 'bg-danger' : 'bg-success'}">
                            ${item.AssessmentResult}
                        </span>
                    </div>
                    
                    ${aiAdvice !== 'ไม่มีข้อมูล' ? `
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-secondary w-100" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#aiDetail${idx}">
                                <i class="fas fa-robot me-1"></i>คำแนะนำจาก AI
                            </button>
                            <div class="collapse mt-2" id="aiDetail${idx}">
                                <div class="card card-body bg-light" style="font-size: 0.85rem;">
                                    ${aiAdvice}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${item.AppointmentDate ? `
                        <div class="mt-2">
                            <small class="text-primary">
                                <i class="fas fa-calendar-check me-1"></i>นัดหมาย: ${new Date(item.AppointmentDate).toLocaleDateString('th-TH')}
                            </small>
                        </div>
                    ` : ''}
                `;
                timeline.appendChild(div);
            });
            
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        }

        // Appointment
        window.openAppoint = function(id, name, email, line) {
            document.getElementById('appCaseId').value = id;
            document.getElementById('appName').value = name;
            document.getElementById('appDate').value = '';
            document.getElementById('appNote').value = '';
            new bootstrap.Modal(document.getElementById('appointmentModal')).show();
        }

        window.saveAppointment = function() {
            const id = document.getElementById('appCaseId').value;
            const date = document.getElementById('appDate').value;
            const note = document.getElementById('appNote').value;
            
            if(!date) {
                alert("กรุณาระบุวันที่นัดหมาย");
                return;
            }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    action: 'save_appointment',
                    id: id,
                    date: date,
                    note: note
                })
            })
            .then(() => {
                alert("✅ บันทึกนัดหมายสำเร็จ!");
                bootstrap.Modal.getInstance(document.getElementById('appointmentModal')).hide();
                loadDashboardData();
            })
            .catch(e => {
                alert("เกิดข้อผิดพลาด: " + e);
            })
            .finally(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }

        // Chat
        window.toggleChat = () => {
            const w = document.getElementById('chatWindow');
            w.style.display = w.style.display === 'flex' ? 'none' : 'flex';
        }

        window.sendChat = async () => {
            const inp = document.getElementById('chatMsg');
            const msg = inp.value.trim();
            if(!msg) return;
            
            const body = document.getElementById('chatBody');
            body.innerHTML += `<div class="message user">${msg}</div>`;
            inp.value = '';
            body.scrollTop = body.scrollHeight;
            
            try {
                const model = getGenAI().getGenerativeModel({ model: "gemini-3-flash-preview" });
                const prompt = `คุณคือผู้ช่วย AI ด้านการดูแลเด็กสมาธิสั้น (ADHD) ตอบคำถามของพ่อแม่หรือครูแบบกระชับและเข้าใจง่าย:\n\n${msg}`;
                const res = await model.generateContent(prompt);
                const aiText = res.response.text();
                body.innerHTML += `<div class="message ai">${aiText}</div>`;
                body.scrollTop = body.scrollHeight;
            } catch(e) {
                body.innerHTML += `<div class="message ai">ขออภัย เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง</div>`;
            }
        }

        // Enter to send chat
        document.getElementById('chatMsg').addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
                sendChat();
            }
        });
// ==================== ฟังก์ชันค้นหาเด็ก ====================
        
        window.searchChildHistory = function() {
            const searchTerm = document.getElementById('searchChild').value.trim();
            
            if(!searchTerm) {
                alert('กรุณาระบุชื่อหรือเลข CID');
                return;
            }
            
            if(searchTerm.length < 3) {
                alert('กรุณาพิมพ์อย่างน้อย 3 ตัวอักษร');
                return;
            }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'search_child',
                    searchTerm: searchTerm
                })
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('loadingOverlay').style.display = 'none';
                
                if(data.status === 'success' && data.results.length > 0) {
                    displaySearchResults(data.results);
                } else {
                    alert('ไม่พบข้อมูลเด็กที่ค้นหา');
                    document.getElementById('searchResults').style.display = 'none';
                }
            })
            .catch(e => {
                console.error('Search error:', e);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('เกิดข้อผิดพลาดในการค้นหา');
            });
        }

        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResultsList');
            const container = document.getElementById('searchResults');
            
            let html = '<div class="list-group mb-3">';
            
            results.forEach((child, index) => {
                const latestAssessment = child.assessments[child.assessments.length - 1];
                const assessmentDate = new Date(latestAssessment.date).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                html += `
                    <a href="#" class="list-group-item list-group-item-action" 
                       onclick="selectChild(${index}); return false;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1 text-primary">
                                    <i class="fas fa-user me-2"></i>${child.name}
                                </h6>
                                <small class="d-block mb-1">
                                    <i class="fas fa-id-card me-1"></i>CID: ${child.cid || 'ไม่มี'} | 
                                    <i class="fas fa-birthday-cake me-1"></i>อายุ: ${child.age} ปี | 
                                    <i class="fas fa-venus-mars me-1"></i>${child.gender}
                                </small>
                                <small class="text-muted d-block">
                                    <i class="fas fa-clock me-1"></i>ประเมินล่าสุด: ${assessmentDate}
                                </small>
                                ${latestAssessment.result ? `
                                    <span class="badge ${latestAssessment.result.includes('เสี่ยง') ? 'bg-danger' : 'bg-success'} mt-1">
                                        ${latestAssessment.result}
                                    </span>
                                ` : ''}
                            </div>
                            <div class="text-end">
                                <span class="badge bg-info" style="font-size: 1rem;">
                                    ${child.totalAssessments} ครั้ง
                                </span>
                            </div>
                        </div>
                    </a>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
            container.style.display = 'block';
            
            window.searchResultsData = results;
        }

        function selectChild(index) {
            const child = window.searchResultsData[index];
            const latestAssessment = child.assessments[child.assessments.length - 1];
            
            document.getElementById('childName').value = child.name;
            document.getElementById('childCID').value = child.cid || '';
            document.getElementById('childAge').value = child.age;
            document.getElementById('childGender').value = child.gender;
            document.getElementById('lineId').value = latestAssessment.lineId || '';
            document.getElementById('emailContact').value = latestAssessment.email || '';
            
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchChild').value = '';
            
            document.getElementById('childName').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            alert(`✅ ข้อมูลของ "${child.name}" ถูกนำมาใส่แล้ว\n\nประวัติการประเมิน: ${child.totalAssessments} ครั้ง\nผลล่าสุด: ${latestAssessment.result || 'ไม่ทราบ'}\n\nกรุณาตรวจสอบข้อมูลและทำการประเมินต่อ`);
        }

        window.clearSearch = function() {
            document.getElementById('searchChild').value = '';
            document.getElementById('searchResults').style.display = 'none';
            window.searchResultsData = null;
        }

        // ==================== ฟังก์ชันการวินิจฉัยและยา ====================

        window.openDiagnosis = function(recordId, childName, currentDiagnosis, currentMedication, currentMedicationDate) {
            document.getElementById('diagnosisRecordID').value = recordId;
            document.getElementById('diagnosisChildName').innerText = childName;
            
            document.getElementById('diagnosisInput').value = currentDiagnosis || '';
            document.getElementById('medicationInput').value = currentMedication || '';
            document.getElementById('medicationDateInput').value = currentMedicationDate || '';
            
            new bootstrap.Modal(document.getElementById('diagnosisModal')).show();
        }

        window.saveDiagnosis = function() {
            const recordId = document.getElementById('diagnosisRecordID').value;
            const diagnosis = document.getElementById('diagnosisInput').value.trim();
            const medication = document.getElementById('medicationInput').value.trim();
            const medicationDate = document.getElementById('medicationDateInput').value;
            
            if(!diagnosis && !medication) {
                alert('กรุณากรอกข้อมูลการวินิจฉัยหรือยาที่จ่ายอย่างน้อย 1 รายการ');
                return;
            }
            
            if(medication && !medicationDate) {
                if(!confirm('คุณไม่ได้ระบุวันที่จ่ายยา ต้องการบันทึกต่อหรือไม่?')) {
                    return;
                }
            }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'update_diagnosis',
                    recordId: recordId,
                    diagnosis: diagnosis,
                    medication: medication,
                    medicationDate: medicationDate
                })
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('loadingOverlay').style.display = 'none';
                
                if(data.status === 'success') {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('diagnosisModal'));
                    modal.hide();
                    alert('✅ บันทึกข้อมูลการวินิจฉัยและยาสำเร็จ');
                    loadDashboardData();
                } else {
                    alert('❌ เกิดข้อผิดพลาด: ' + data.message);
                }
            })
            .catch(e => {
                console.error('Save diagnosis error:', e);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('เกิดข้อผิดพลาดในการบันทึก');
            });
        }

    </script>
</body>
</html>

